<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Create Parent Account | Shuleni Advantage</title>
  <link rel="icon" href="/favicon.ico" type="image/png">
  <link rel="stylesheet" href="/shared/portal-theme.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', 'Poppins', sans-serif;
      color: var(--text-dark);
    }

    .brand-link {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      text-decoration: none;
      color: var(--text-dark);
      font-weight: 700;
    }

    .garden-body {
      position: relative;
      overflow-y: auto;
      overflow-x: hidden;
    }

    .garden-body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #0f4c3a 0%, #1a5f47 25%, #2d7a5f 50%, #8b1538 75%, #6b1a2f 100%);
      background-size: 400% 400%;
      animation: gradientShift 20s ease infinite;
      z-index: -1;
      opacity: 0.1;
    }

    @keyframes gradientShift {
      0% {
        background-position: 0% 50%;
      }

      50% {
        background-position: 100% 50%;
      }

      100% {
        background-position: 0% 50%;
      }
    }

    .registration-shell {
      padding: 2rem 2.5rem;
      border: 1px solid var(--border);
      margin-top: 0.5rem;
      border-radius: 16px;
      box-shadow: 0 14px 32px rgba(0, 0, 0, 0.08);
      background: rgba(255, 255, 255, 0.94);
    }

    .registration-grid {
      margin-top: 1.5rem;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1.6rem;
    }

    .form-section h2 {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--primary-dark);
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .form-section h2::before {
      content: '';
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--primary-medium);
      box-shadow: 0 0 0 6px rgba(15, 42, 23, 0.08);
    }

    .input-group {
      margin-bottom: 1rem;
    }

    .input-group label {
      display: block;
      margin-bottom: 0.4rem;
      font-weight: 600;
      color: var(--text-dark);
    }

    .helper-text {
      font-size: 0.9rem;
      color: var(--text-medium);
      margin-top: -0.4rem;
      margin-bottom: 1rem;
    }

    .form-status {
      margin-bottom: 1rem;
      padding: 0.85rem 1rem;
      border-radius: 10px;
      font-weight: 600;
      display: none;
    }

    .form-status.info {
      background: rgba(15, 42, 23, 0.08);
      color: var(--primary-medium);
      border: 1px solid rgba(15, 42, 23, 0.15);
    }

    .form-status.success {
      background: rgba(22, 163, 74, 0.12);
      color: var(--success-dark);
      border: 1px solid rgba(22, 163, 74, 0.2);
    }

    .form-status.error {
      background: rgba(239, 68, 68, 0.12);
      color: #b91c1c;
      border: 1px solid rgba(239, 68, 68, 0.2);
    }

    .child-list {
      margin-top: 1rem;
      padding: 1rem;
      background: rgba(15, 42, 23, 0.04);
      border-radius: 12px;
      border: 1px dashed rgba(15, 42, 23, 0.2);
      color: var(--text-medium);
      font-size: 0.95rem;
    }

    .child-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 0;
      border-bottom: 1px solid rgba(15, 42, 23, 0.08);
    }

    .child-row:last-child {
      border-bottom: none;
    }

    .child-row button {
      border: none;
      background: transparent;
      color: var(--primary-medium);
      font-weight: 600;
      cursor: pointer;
    }

    .cta-row {
      margin-top: 2rem;
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      justify-content: center;
    }

    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 100;
      padding: 1.5rem;
    }

    .modal-content {
      background: var(--surface);
      padding: 2rem;
      border-radius: 16px;
      width: min(420px, 100%);
      box-shadow: 0 25px 60px rgba(15, 42, 23, 0.25);
      border: 1px solid var(--border);
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 0.75rem;
      margin-top: 1.5rem;
    }

    @media (max-width: 768px) {
      .registration-shell {
        padding: 2rem 1.25rem;
      }
    }

    .phone-input-container {
      display: flex;
      gap: 8px;
    }

    .country-code-select {
      flex: 0 0 100px;
      padding: 10px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
      background-color: white;
    }

    .password-input-container {
      position: relative;
      display: flex;
    }

    .toggle-password {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      cursor: pointer;
      color: #6b7280;
    }

    .password-requirements {
      margin-top: 8px;
      font-size: 13px;
      color: #4b5563;
    }

    .password-requirements ul {
      margin: 5px 0 0 0;
      padding-left: 20px;
    }

    .password-requirements li {
      position: relative;
      margin-bottom: 4px;
      list-style-type: none;
    }

    .password-requirements li:before {
      content: '✗';
      color: #ef4444;
      margin-right: 8px;
    }

    .password-requirements li.valid:before {
      content: '✓';
      color: #10b981;
    }

    .validation-message {
      font-size: 13px;
      margin-top: 4px;
    }

    .validation-message.valid {
      color: #10b981;
    }

    .validation-message.error {
      color: #ef4444;
    }
  </style>
</head>

<body class="garden-body">

  <header class="garden-header">
    <div class="brand-pill">
      <a href="/index.html" class="brand-link">
        <img src="/favicon.ico" alt="Shuleni Advantage Logo" class="brand-icon">
        <span>Shuleni Advantage</span>
      </a>
    </div>
  </header>

  <main class="garden-main">
    <a href="/index.html" class="back-link" id="backToHome">
      <i class="fas fa-arrow-left"></i>
      Back to Home
    </a>

    <section class="theme-card registration-shell">
      <div class="section-lead">
        <h1>Create Your Parent Account</h1>
        <p>Connect directly to live attendance, fee balances, and school announcements. Register once and link every
          child using their admission number.</p>
      </div>

      <form id="parentAccountForm" novalidate>
        <div id="formStatus" class="form-status" role="alert" style="display: none;"></div>
        <div class="registration-grid">
          <div class="form-section">
            <span class="theme-badge">Step 1 · Guardian Details</span>
            <h2>Your Profile</h2>
            <div class="input-group">
              <label for="parentName">Full Name</label>
              <input type="text" id="parentName" class="theme-input" placeholder="Jane Doe" required>
            </div>
            <div class="input-group">
              <label for="parentPhone">Phone Number</label>
              <div class="phone-input-container">
                <select id="countryCode" class="country-code-select" required>
                  <option value="+254">KE +254</option>
                  <option value="+255">TZ +255</option>
                  <option value="+256">UG +256</option>
                  <option value="+250">RW +250</option>
                </select>
                <input type="tel" id="parentPhone" class="theme-input" placeholder="700 000 000" pattern="[0-9]{9,15}"
                  required>
              </div>
            </div>
            <div class="input-group">
              <label for="parentEmail">Email</label>
              <input type="email" id="parentEmail" class="theme-input" placeholder="parent@email.com" required>
            </div>
            <div class="input-group">
              <label for="parentPassword">Password</label>
              <div class="password-input-container">
                <input type="password" id="parentPassword" class="theme-input" placeholder="••••••••" minlength="8"
                  required>
                <button type="button" class="toggle-password" aria-label="Toggle password visibility">
                  <i class="fas fa-eye"></i>
                </button>
              </div>
              <div class="password-requirements">
                Password must be at least 8 characters long and include:
                <ul>
                  <li class="req-uppercase">1 uppercase letter</li>
                  <li class="req-lowercase">1 lowercase letter</li>
                  <li class="req-number">1 number</li>
                  <li class="req-special">1 special character</li>
                </ul>
              </div>
            </div>
            <div class="input-group">
              <label for="confirmParentPassword">Confirm Password</label>
              <div class="password-input-container">
                <input type="password" id="confirmParentPassword" class="theme-input" placeholder="Repeat password"
                  minlength="8" required>
                <button type="button" class="toggle-password" aria-label="Toggle password visibility">
                  <i class="fas fa-eye"></i>
                </button>
              </div>
              <div id="passwordMatch" class="validation-message"></div>
            </div>
          </div>

          <div class="form-section">
            <span class="theme-badge">Step 2 · Link Children</span>
            <h2>Student Profiles</h2>
            <p class="helper-text">Use the same admission numbers already stored by the school so we can attach your
              dashboard immediately.</p>
            <div class="input-group">
              <label for="studentName">Student Name</label>
              <input type="text" id="studentName" class="theme-input" placeholder="Student name" required>
            </div>
            <div class="input-group">
              <label for="studentClass">Class</label>
              <input type="text" id="studentClass" class="theme-input" placeholder="Grade 8 Blue" required>
            </div>
            <div class="input-group">
              <label for="studentReg">Registration / Admission No.</label>
              <input type="text" id="studentReg" class="theme-input" placeholder="ST1234" required>
            </div>

            <button type="button" class="theme-btn outline" id="openChildModal">
              ➕ Add another child
            </button>

            <div class="child-list" id="childList">
              No additional children added yet.
            </div>
          </div>
        </div>

        <hr class="theme-divider" />

        <div class="cta-row">
          <button type="submit" class="theme-btn primary" id="submitRegistration">Verify & Register Account</button>
          <a href="parent_login_page.html" class="theme-btn outline" style="text-decoration:none;">Already registered?
            Sign in</a>
        </div>
      </form>
    </section>
  </main>

  <!-- Modal -->
  <div class="modal" id="childModal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal-content">
      <h3 id="modalTitle">Add Another Child</h3>
      <div class="input-group">
        <label for="modalChildName">Student Name</label>
        <input type="text" id="modalChildName" class="theme-input" required>
      </div>
      <div class="input-group">
        <label for="modalChildClass">Class</label>
        <input type="text" id="modalChildClass" class="theme-input" required>
      </div>
      <div class="input-group">
        <label for="modalChildReg">Registration Number</label>
        <input type="text" id="modalChildReg" class="theme-input" required>
      </div>
      <div class="modal-actions">
        <button class="theme-btn outline" id="cancelModal" type="button">Cancel</button>
        <button class="theme-btn primary" id="saveChild" type="button">Save Child</button>
      </div>
    </div>
  </div>

  <footer class="garden-footer">
    <p>By creating an account, you agree to our <a href="#" class="theme-link">Privacy Policy</a> and <a href="#"
        class="theme-link">Terms of Service</a>.</p>
    <p style="margin-top: 1rem; font-size: 0.9rem; color: var(--text-muted);">© 2025 Hechlink Ventures. All rights
      reserved.</p>
  </footer>

  <script src="/runtime-config.js"></script>
  <script src="/shared/api-client.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const modal = document.getElementById('childModal');
      const addChildBtn = document.getElementById('openChildModal');
      const cancelModal = document.getElementById('cancelModal');
      const saveChild = document.getElementById('saveChild');
      const childList = document.getElementById('childList');
      const formStatus = document.getElementById('formStatus');
      const registrationForm = document.getElementById('parentAccountForm');
      const passwordInput = document.getElementById('parentPassword');
      const confirmPasswordInput = document.getElementById('confirmParentPassword');
      const passwordMatch = document.getElementById('passwordMatch');
      const backLink = document.getElementById('backToHome');
      const addedChildren = [];

      if (backLink) {
        backLink.addEventListener('click', (e) => {
          e.preventDefault();
          window.location.href = '/index.html';
        });
      }

      function showStatus(message, variant = 'info') {
        if (!message) {
          formStatus.style.display = 'none';
          return;
        }
        formStatus.textContent = message;
        formStatus.className = `form-status ${variant}`;
        formStatus.style.display = 'block';
      }

      function renderChildList() {
        if (!addedChildren.length) {
          childList.innerHTML = 'No additional children added yet.';
          return;
        }

        childList.innerHTML = addedChildren.map((child, index) => `
          <div class="child-row">
            <div>
              <strong>${child.name}</strong> • ${child.className} • ${child.admission}
            </div>
            <button type="button" data-index="${index}">Remove</button>
          </div>
        `).join('');

        childList.querySelectorAll('button[data-index]').forEach(btn => {
          btn.addEventListener('click', () => {
            addedChildren.splice(Number(btn.dataset.index), 1);
            renderChildList();
          });
        });
      }

      function resetModalFields() {
        document.getElementById('modalChildName').value = '';
        document.getElementById('modalChildClass').value = '';
        document.getElementById('modalChildReg').value = '';
      }

      function closeModal() {
        modal.style.display = 'none';
        resetModalFields();
      }

      function validatePassword() {
        const password = passwordInput.value;
        const requirements = {
          uppercase: /[A-Z]/.test(password),
          lowercase: /[a-z]/.test(password),
          number: /[0-9]/.test(password),
          special: /[^A-Za-z0-9]/.test(password),
          length: password.length >= 8
        };

        document.querySelector('.req-uppercase').classList.toggle('valid', requirements.uppercase);
        document.querySelector('.req-lowercase').classList.toggle('valid', requirements.lowercase);
        document.querySelector('.req-number').classList.toggle('valid', requirements.number);
        document.querySelector('.req-special').classList.toggle('valid', requirements.special);

        return requirements.uppercase && requirements.lowercase &&
          requirements.number && requirements.special && requirements.length;
      }

      function checkPasswordsMatch() {
        const password = passwordInput.value;
        const confirmPassword = confirmPasswordInput.value;

        if (!confirmPassword) {
          passwordMatch.textContent = '';
          passwordMatch.className = 'validation-message';
          return false;
        }

        if (password === confirmPassword) {
          passwordMatch.textContent = 'Passwords match';
          passwordMatch.className = 'validation-message valid';
          return true;
        }

        passwordMatch.textContent = 'Passwords do not match';
        passwordMatch.className = 'validation-message error';
        return false;
      }

      async function submitForm() {
        const submitBtn = registrationForm.querySelector('button[type="submit"]');
        const originalBtnText = submitBtn.textContent;

        try {
          submitBtn.disabled = true;
          submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating account...';
          showStatus('Creating your account...', 'info');

          const parentName = document.getElementById('parentName').value.trim();
          const countryCode = document.getElementById('countryCode').value;
          const phoneNumber = document.getElementById('parentPhone').value.trim();
          const parentPhone = `${countryCode}${phoneNumber}`;
          const parentEmail = document.getElementById('parentEmail').value.trim().toLowerCase();
          const parentPassword = document.getElementById('parentPassword').value;

          const mainStudent = {
            name: document.getElementById('studentName').value.trim(),
            className: document.getElementById('studentClass').value.trim(),
            admission: document.getElementById('studentReg').value.trim().toUpperCase()
          };

          const children = [mainStudent, ...addedChildren];

          const requestBody = {
            parent: {
              name: parentName,
              phone: parentPhone,
              email: parentEmail,
              password: parentPassword
            },
            students: children
          };

          const response = await fetch('/api/parents/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestBody)
          });

          const result = await response.json();

          if (!response.ok) {
            throw new Error(result.message || 'Registration failed. Please try again.');
          }

          showStatus('Account created successfully! Redirecting...', 'success');
          setTimeout(() => {
            window.location.href = 'parent_login_page.html?registered=true';
          }, 2000);
        } catch (error) {
          console.error('Registration error:', error);
          showStatus(error.message || 'An error occurred during registration. Please try again.', 'error');
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalBtnText;
        }
      }

      document.querySelectorAll('.toggle-password').forEach(button => {
        button.addEventListener('click', function () {
          const input = this.previousElementSibling;
          const type = input.type === 'password' ? 'text' : 'password';
          input.type = type;
          this.querySelector('i').classList.toggle('fa-eye');
          this.querySelector('i').classList.toggle('fa-eye-slash');
        });
      });

      addChildBtn?.addEventListener('click', () => modal.style.display = 'flex');
      cancelModal?.addEventListener('click', closeModal);

      saveChild?.addEventListener('click', () => {
        const name = document.getElementById('modalChildName').value.trim();
        const className = document.getElementById('modalChildClass').value.trim();
        const admission = document.getElementById('modalChildReg').value.trim().toUpperCase();

        if (name && className && admission) {
          addedChildren.push({ name, className, admission });
          renderChildList();
          closeModal();
        } else {
          alert('Please fill in all fields.');
        }
      });

      window.addEventListener('click', e => {
        if (e.target === modal) closeModal();
      });

      registrationForm?.addEventListener('submit', (e) => {
        e.preventDefault();

        if (!registrationForm.checkValidity()) {
          e.stopPropagation();
          registrationForm.classList.add('was-validated');
          return;
        }

        if (!validatePassword()) {
          showStatus('Please ensure your password meets all requirements', 'error');
          return;
        }

        if (!checkPasswordsMatch()) {
          showStatus('Passwords do not match', 'error');
          return;
        }

        submitForm();
      });

      passwordInput?.addEventListener('input', validatePassword);
      confirmPasswordInput?.addEventListener('input', checkPasswordsMatch);
      renderChildList();
    });
  </script>
</body>

</html>
