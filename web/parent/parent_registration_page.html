<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Create Parent Account | Shuleni Advantage</title>
  <link rel="icon" href="/favicon.ico" type="image/png">
  <link rel="apple-touch-icon" href="/favicon.ico">
  <meta name="theme-color" content="#064e3b">
  <link rel="stylesheet" href="/shared/portal-theme.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    :root {
      --primary: #059669;
      --primary-dark: #064e3b;
      --accent: #8b5cf6;
      --glass-bg: rgba(255, 255, 255, 0.75);
      --glass-border: rgba(255, 255, 255, 0.3);
      --text-main: #1e293b;
      --text-muted: #64748b;
    }

    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background: radial-gradient(circle at top left, #e0f2fe 0%, #f0fdf4 40%, #fafaf9 100%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .garden-header {
      padding: 1.5rem;
      display: flex;
      justify-content: center;
    }

    .brand-pill {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 20px;
      background: var(--glass-bg);
      backdrop-filter: blur(10px);
      border-radius: 99px;
      border: 1px solid var(--glass-border);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      font-weight: 800;
      text-decoration: none;
      color: var(--primary-dark);
    }

    .brand-icon {
      width: 32px;
      height: 32px;
    }

    .garden-main {
      flex: 1;
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
      width: 100%;
      box-sizing: border-box;
    }

    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: var(--primary);
      text-decoration: none;
      font-weight: 700;
      margin-bottom: 1.5rem;
      transition: transform 0.3s ease;
    }

    .back-link:hover {
      transform: translateX(-4px);
    }

    .registration-shell {
      background: var(--glass-bg);
      backdrop-filter: blur(12px);
      border: 1px solid var(--glass-border);
      padding: 3rem;
      border-radius: 32px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
    }

    .section-lead {
      text-align: center;
      margin-bottom: 2.5rem;
    }

    .section-lead h1 {
      font-size: 2.2rem;
      font-weight: 900;
      background: linear-gradient(135deg, #064e3b 0%, #059669 100%);
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 0.75rem;
    }

    .registration-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 2.5rem;
      margin-top: 1rem;
    }

    .form-section h2 {
      font-size: 1.3rem;
      font-weight: 800;
      color: var(--primary-dark);
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .theme-badge {
      display: inline-block;
      padding: 4px 12px;
      background: #dcfce7;
      color: #15803d;
      border-radius: 99px;
      font-size: 0.75rem;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.5rem;
    }

    .input-group {
      margin-bottom: 1.25rem;
    }

    .input-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 700;
      color: var(--text-main);
      font-size: 0.9rem;
    }

    .theme-input {
      width: 100%;
      padding: 14px 18px;
      border: 2px solid rgba(0, 0, 0, 0.05);
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.5);
      font-size: 0.95rem;
      outline: none;
      transition: all 0.3s ease;
      box-sizing: border-box;
    }

    .theme-input:focus {
      border-color: #059669;
      background: white;
      box-shadow: 0 0 0 4px rgba(5, 150, 105, 0.1);
    }

    /* Validation Styles */
    .was-validated .theme-input:invalid {
      border-color: #ef4444;
      background-color: #fef2f2;
    }

    .validation-message.error {
      color: #ef4444;
      font-size: 0.8rem;
      font-weight: 600;
      margin-top: 4px;
    }

    .form-status {
      padding: 1rem 1.5rem;
      border-radius: 12px;
      margin-bottom: 2rem;
      font-weight: 600;
      animation: slideDown 0.3s ease;
    }

    .form-status.info {
      background: #e0f2fe;
      color: #0369a1;
      border: 1px solid #bae6fd;
    }

    .form-status.success {
      background: #dcfce7;
      color: #15803d;
      border: 1px solid #bbf7d0;
    }

    .form-status.error {
      background: #fee2e2;
      color: #b91c1c;
      border: 1px solid #fecaca;
    }

    @keyframes slideDown {
      from {
        transform: translateY(-10px);
        opacity: 0;
      }

      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .password-input-container {
      position: relative;
    }

    .toggle-password {
      position: absolute;
      right: 14px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
    }

    .password-requirements {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 0.5rem;
      background: rgba(0, 0, 0, 0.02);
      padding: 1rem;
      border-radius: 10px;
    }

    .password-requirements ul {
      margin: 8px 0 0 0;
      padding-left: 20px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 4px;
    }

    .password-requirements li {
      margin-bottom: 2px;
      list-style: none;
    }

    .password-requirements li::before {
      content: '●';
      margin-right: 8px;
      font-size: 0.6rem;
      vertical-align: middle;
    }

    .password-requirements li.valid {
      color: #059669;
      font-weight: 700;
    }

    .child-list {
      background: rgba(255, 255, 255, 0.4);
      padding: 1.25rem;
      border-radius: 16px;
      border: 2px dashed rgba(5, 150, 105, 0.2);
      margin-top: 1rem;
    }

    .child-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 0;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      font-weight: 600;
      font-size: 0.9rem;
    }

    .child-row button {
      background: #fee2e2;
      color: #dc2626;
      border: none;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 0.8rem;
      font-weight: 700;
      cursor: pointer;
    }

    .cta-row {
      margin-top: 3rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      align-items: center;
    }

    .theme-btn.primary {
      padding: 18px 40px;
      border-radius: 16px;
      background: linear-gradient(135deg, #059669 0%, #064e3b 100%);
      color: white;
      font-weight: 800;
      border: none;
      cursor: pointer;
      font-size: 1.1rem;
      transition: all 0.3s ease;
      box-shadow: 0 10px 20px rgba(5, 150, 105, 0.2);
      width: 100%;
      max-width: 400px;
    }

    .theme-btn.outline {
      padding: 14px 24px;
      border-radius: 12px;
      border: 2px solid #059669;
      background: transparent;
      color: #059669;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .modal {
      position: fixed;
      inset: 0;
      background: rgba(6, 78, 59, 0.4);
      backdrop-filter: blur(8px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 100;
      padding: 1.5rem;
    }

    .modal-content {
      background: white;
      padding: 2.5rem;
      border-radius: 28px;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.1);
    }

    .garden-footer {
      padding: 3rem;
      text-align: center;
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    @media (max-width: 768px) {
      .registration-shell {
        padding: 2rem;
      }

      .registration-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body class="garden-body">

  <header class="garden-header">
    <div class="brand-pill">
      <a href="/index.html" class="brand-link">
        <img src="/assets/hechlink_final.png" alt="Shuleni Advantage Logo" class="brand-icon">
        <span>Shuleni Advantage</span>
      </a>
    </div>
  </header>

  <main class="garden-main">
    <a href="/index.html" class="back-link" id="backToHome">
      <i class="fas fa-arrow-left"></i>
      Back to Home
    </a>

    <section class="theme-card registration-shell">
      <div class="section-lead">
        <h1>Create Your Parent Account</h1>
        <p>Connect directly to live attendance, fee balances, and school announcements. Register once and link every
          child using their admission number.</p>
      </div>

      <form id="parentAccountForm" novalidate>
        <div id="formStatus" class="form-status" role="alert" style="display: none;"></div>
        <div class="registration-grid">
          <div class="form-section">
            <span class="theme-badge">Step 1 · Guardian Details</span>
            <h2>Your Profile</h2>
            <div class="input-group">
              <label for="parentName">Full Name</label>
              <input type="text" id="parentName" class="theme-input" placeholder="Jane Doe" required>
            </div>
            <div class="input-group">
              <label for="parentPhone">Phone Number</label>
              <div class="phone-input-container">
                <select id="countryCode" class="country-code-select" required>
                  <option value="+254">KE +254</option>
                  <option value="+255">TZ +255</option>
                  <option value="+256">UG +256</option>
                  <option value="+250">RW +250</option>
                </select>
                <input type="tel" id="parentPhone" class="theme-input" placeholder="700 000 000" pattern="[0-9]{9,15}"
                  required>
              </div>
            </div>
            <div class="input-group">
              <label for="parentEmail">Email</label>
              <input type="email" id="parentEmail" class="theme-input" placeholder="parent@email.com" required>
            </div>
            <div class="input-group">
              <label for="parentPassword">Password</label>
              <div class="password-input-container">
                <input type="password" id="parentPassword" class="theme-input" placeholder="••••••••" minlength="8"
                  required>
                <button type="button" class="toggle-password" aria-label="Toggle password visibility">
                  <i class="fas fa-eye"></i>
                </button>
              </div>
              <div class="password-requirements">
                Password must be at least 8 characters long and include:
                <ul>
                  <li class="req-uppercase">1 uppercase letter</li>
                  <li class="req-lowercase">1 lowercase letter</li>
                  <li class="req-number">1 number</li>
                  <li class="req-special">1 special character</li>
                </ul>
              </div>
            </div>
            <div class="input-group">
              <label for="confirmParentPassword">Confirm Password</label>
              <div class="password-input-container">
                <input type="password" id="confirmParentPassword" class="theme-input" placeholder="Repeat password"
                  minlength="8" required>
                <button type="button" class="toggle-password" aria-label="Toggle password visibility">
                  <i class="fas fa-eye"></i>
                </button>
              </div>
              <div id="passwordMatch" class="validation-message"></div>
            </div>
          </div>

          <div class="form-section">
            <span class="theme-badge">Step 2 · Link Children</span>
            <h2>Student Profiles</h2>
            <p class="helper-text">Use the same admission numbers already stored by the school so we can attach your
              dashboard immediately.</p>
            <div class="input-group">
              <label for="studentName">Student Name</label>
              <input type="text" id="studentName" class="theme-input" placeholder="Student name" required>
            </div>
            <div class="input-group">
              <label for="studentClass">Class</label>
              <input type="text" id="studentClass" class="theme-input" placeholder="Grade 8 Blue" required>
            </div>
            <div class="input-group">
              <label for="studentReg">Registration / Admission No.</label>
              <input type="text" id="studentReg" class="theme-input" placeholder="ST1234" required>
            </div>

            <button type="button" class="theme-btn outline" id="openChildModal">
              ➕ Add another child
            </button>

            <div class="child-list" id="childList">
              No additional children added yet.
            </div>
          </div>
        </div>

        <hr class="theme-divider" />

        <div class="cta-row">
          <button type="submit" class="theme-btn primary" id="submitRegistration">Verify & Register Account</button>
          <a href="parent_login_page.html" class="theme-btn outline" style="text-decoration:none;">Already registered?
            Sign in</a>
        </div>
      </form>
    </section>
  </main>

  <!-- Modal -->
  <div class="modal" id="childModal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal-content">
      <h3 id="modalTitle">Add Another Child</h3>
      <div class="input-group">
        <label for="modalChildName">Student Name</label>
        <input type="text" id="modalChildName" class="theme-input" required>
      </div>
      <div class="input-group">
        <label for="modalChildClass">Class</label>
        <input type="text" id="modalChildClass" class="theme-input" required>
      </div>
      <div class="input-group">
        <label for="modalChildReg">Registration Number</label>
        <input type="text" id="modalChildReg" class="theme-input" required>
      </div>
      <div class="modal-actions">
        <button class="theme-btn outline" id="cancelModal" type="button">Cancel</button>
        <button class="theme-btn primary" id="saveChild" type="button">Save Child</button>
      </div>
    </div>
  </div>

  <footer class="garden-footer">
    <p>By creating an account, you agree to our <a href="#" class="theme-link">Privacy Policy</a> and <a href="#"
        class="theme-link">Terms of Service</a>.</p>
    <p style="margin-top: 1rem; font-size: 0.9rem; color: var(--text-muted);">© 2025 Hechlink Ventures. All rights
      reserved.</p>
  </footer>

  <script src="/runtime-config.js"></script>
  <script src="/shared/api-client.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // API Base URL from config
      const API_BASE = (window.StudentCardConfig && window.StudentCardConfig.apiBaseUrl) || '/api';

      const modal = document.getElementById('childModal');
      const addChildBtn = document.getElementById('openChildModal');
      const cancelModal = document.getElementById('cancelModal');
      const saveChild = document.getElementById('saveChild');
      const childList = document.getElementById('childList');
      const formStatus = document.getElementById('formStatus');
      const registrationForm = document.getElementById('parentAccountForm');
      const passwordInput = document.getElementById('parentPassword');
      const confirmPasswordInput = document.getElementById('confirmParentPassword');
      const passwordMatch = document.getElementById('passwordMatch');
      const backLink = document.getElementById('backToHome');
      const addedChildren = [];

      if (backLink) {
        backLink.addEventListener('click', (e) => {
          e.preventDefault();
          window.location.href = '/index.html';
        });
      }

      function showStatus(message, variant = 'info') {
        if (!message) {
          formStatus.style.display = 'none';
          return;
        }
        formStatus.textContent = message;
        formStatus.className = `form-status ${variant}`;
        formStatus.style.display = 'block';

        // Scroll to status if it's an error
        if (variant === 'error') {
          formStatus.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      }

      function renderChildList() {
        if (!addedChildren.length) {
          childList.innerHTML = 'No additional children added yet.';
          return;
        }

        childList.innerHTML = addedChildren.map((child, index) => `
          <div class="child-row">
            <div>
              <strong>${child.name}</strong> • ${child.className} • ${child.admission}
            </div>
            <button type="button" data-index="${index}">Remove</button>
          </div>
        `).join('');

        childList.querySelectorAll('button[data-index]').forEach(btn => {
          btn.addEventListener('click', () => {
            addedChildren.splice(Number(btn.dataset.index), 1);
            renderChildList();
          });
        });
      }

      function resetModalFields() {
        document.getElementById('modalChildName').value = '';
        document.getElementById('modalChildClass').value = '';
        document.getElementById('modalChildReg').value = '';
      }

      function closeModal() {
        modal.style.display = 'none';
        resetModalFields();
      }

      function validatePassword() {
        const password = passwordInput.value;
        const requirements = {
          uppercase: /[A-Z]/.test(password),
          lowercase: /[a-z]/.test(password),
          number: /[0-9]/.test(password),
          special: /[^A-Za-z0-9]/.test(password),
          length: password.length >= 8
        };

        document.querySelector('.req-uppercase').classList.toggle('valid', requirements.uppercase);
        document.querySelector('.req-lowercase').classList.toggle('valid', requirements.lowercase);
        document.querySelector('.req-number').classList.toggle('valid', requirements.number);
        document.querySelector('.req-special').classList.toggle('valid', requirements.special);

        return requirements.uppercase && requirements.lowercase &&
          requirements.number && requirements.special && requirements.length;
      }

      function checkPasswordsMatch() {
        const password = passwordInput.value;
        const confirmPassword = confirmPasswordInput.value;

        if (!confirmPassword) {
          passwordMatch.textContent = '';
          passwordMatch.className = 'validation-message';
          return false;
        }

        if (password === confirmPassword) {
          passwordMatch.textContent = 'Passwords match';
          passwordMatch.className = 'validation-message valid';
          return true;
        }

        passwordMatch.textContent = 'Passwords do not match';
        passwordMatch.className = 'validation-message error';
        return false;
      }

      async function submitForm() {
        const submitBtn = document.getElementById('submitRegistration');
        const originalBtnText = submitBtn.textContent;

        try {
          submitBtn.disabled = true;
          submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating account...';
          showStatus('Creating your account...', 'info');

          const parentName = document.getElementById('parentName').value.trim();
          const countryCode = document.getElementById('countryCode').value;
          const phoneNumber = document.getElementById('parentPhone').value.trim();
          const parentPhone = `${countryCode}${phoneNumber}`;
          const parentEmail = document.getElementById('parentEmail').value.trim().toLowerCase();
          const parentPassword = document.getElementById('parentPassword').value;

          const mainStudent = {
            name: document.getElementById('studentName').value.trim(),
            className: document.getElementById('studentClass').value.trim(),
            admission: document.getElementById('studentReg').value.trim().toUpperCase()
          };

          const children = [mainStudent, ...addedChildren];

          const requestBody = {
            parent: {
              name: parentName,
              phone: parentPhone,
              email: parentEmail,
              password: parentPassword
            },
            students: children
          };

          console.log('Submitting registration:', { ...requestBody, parent: { ...requestBody.parent, password: '***' } });

          const response = await fetch(`${API_BASE}/parents/register`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestBody)
          });

          const result = await response.json();

          if (!response.ok) {
            // Backend error structure uses .error or .message
            throw new Error(result.error || result.message || 'Registration failed. Please try again.');
          }

          showStatus('Account created successfully! Redirecting...', 'success');
          setTimeout(() => {
            window.location.href = 'parent_login_page.html?registered=true';
          }, 2000);
        } catch (error) {
          console.error('Registration error:', error);
          showStatus(error.message || 'An error occurred during registration. Please try again.', 'error');
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalBtnText;
        }
      }

      document.querySelectorAll('.toggle-password').forEach(button => {
        button.addEventListener('click', function () {
          const input = this.previousElementSibling;
          const type = input.type === 'password' ? 'text' : 'password';
          input.type = type;
          this.querySelector('i').classList.toggle('fa-eye');
          this.querySelector('i').classList.toggle('fa-eye-slash');
        });
      });

      addChildBtn?.addEventListener('click', () => modal.style.display = 'flex');
      cancelModal?.addEventListener('click', closeModal);

      saveChild?.addEventListener('click', () => {
        const name = document.getElementById('modalChildName').value.trim();
        const className = document.getElementById('modalChildClass').value.trim();
        const admission = document.getElementById('modalChildReg').value.trim().toUpperCase();

        if (name && className && admission) {
          addedChildren.push({ name, className, admission });
          renderChildList();
          closeModal();
        } else {
          alert('Please fill in all fields.');
        }
      });

      window.addEventListener('click', e => {
        if (e.target === modal) closeModal();
      });

      registrationForm?.addEventListener('submit', (e) => {
        e.preventDefault();

        // Show validation states
        registrationForm.classList.add('was-validated');

        if (!registrationForm.checkValidity()) {
          showStatus('Please fill in all required fields correctly.', 'error');
          return;
        }

        if (!validatePassword()) {
          showStatus('Please ensure your password meets all requirements', 'error');
          return;
        }

        if (!checkPasswordsMatch()) {
          showStatus('Passwords do not match', 'error');
          return;
        }

        submitForm();
      });

      passwordInput?.addEventListener('input', validatePassword);
      confirmPasswordInput?.addEventListener('input', checkPasswordsMatch);
      renderChildList();
    });
  </script>
</body>

</html>
