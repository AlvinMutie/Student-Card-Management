<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Parent Dashboard | Shuleni Advantage</title>
  <link rel="icon" href="/favicon.ico" type="image/png">
  <link rel="stylesheet" href="/shared/portal-theme.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    :root {
      --primary: #059669;
      --primary-dark: #064e3b;
      --accent: #8b5cf6;
      --glass-bg: rgba(255, 255, 255, 0.7);
      --glass-border: rgba(255, 255, 255, 0.3);
      --text-main: #1e293b;
      --text-muted: #64748b;
    }

    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background: radial-gradient(circle at top left, #e0f2fe 0%, #f0fdf4 40%, #fafaf9 100%);
      color: var(--text-main);
      min-height: 100vh;
    }

    .dashboard-layout {
      display: flex;
      min-height: 100vh;
    }

    .sidebar {
      width: 280px;
      background: rgba(6, 78, 59, 0.95);
      backdrop-filter: blur(12px);
      color: white;
      display: flex;
      flex-direction: column;
      position: fixed;
      height: 100vh;
      z-index: 50;
      border-right: 1px solid rgba(255, 255, 255, 0.1);
    }

    .sidebar-header {
      padding: 2.5rem 1.5rem;
      text-align: center;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .sidebar-logo {
      width: 64px;
      height: 64px;
      margin-bottom: 1rem;
      filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.3));
    }

    .sidebar-brand {
      font-size: 1.4rem;
      font-weight: 800;
      display: block;
      letter-spacing: -0.5px;
    }

    .sidebar-nav {
      flex: 1;
      padding: 2rem 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 14px 20px;
      color: rgba(255, 255, 255, 0.7);
      text-decoration: none;
      border-radius: 16px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-weight: 500;
    }

    .nav-item:hover,
    .nav-item.active {
      background: rgba(255, 255, 255, 0.15);
      color: white;
      transform: translateX(6px);
    }

    .nav-item i {
      font-size: 1.2rem;
      width: 24px;
    }

    .main-content {
      flex: 1;
      margin-left: 280px;
      padding: 3rem;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 3rem;
      padding: 1.5rem 2.5rem;
      background: var(--glass-bg);
      backdrop-filter: blur(12px);
      border: 1px solid var(--glass-border);
      border-radius: 24px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.04);
    }

    .user-welcome h1 {
      font-size: 1.8rem;
      font-weight: 800;
      background: linear-gradient(135deg, #064e3b 0%, #059669 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin: 0;
    }

    .student-profile {
      background: linear-gradient(135deg, #064e3b 0%, #059669 100%);
      border-radius: 32px;
      padding: 3rem;
      color: white;
      display: flex;
      align-items: center;
      gap: 3rem;
      margin-bottom: 3rem;
      box-shadow: 0 20px 40px rgba(5, 150, 105, 0.2);
      position: relative;
      overflow: hidden;
    }

    .student-profile::after {
      content: '';
      position: absolute;
      top: -50%;
      right: -10%;
      width: 400px;
      height: 200%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1));
      transform: rotate(25deg);
    }

    .profile-img {
      width: 160px;
      height: 160px;
      border-radius: 40px;
      background: white;
      padding: 6px;
      object-fit: cover;
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
      transition: transform 0.5s ease;
    }

    .student-profile:hover .profile-img {
      transform: scale(1.05) rotate(2deg);
    }

    .profile-details h2 {
      font-size: 2.5rem;
      font-weight: 900;
      margin-bottom: 0.5rem;
      letter-spacing: -1px;
    }

    .profile-badges {
      display: flex;
      gap: 1rem;
      margin-top: 1.5rem;
    }

    .badge {
      padding: 8px 18px;
      border-radius: 14px;
      font-size: 0.9rem;
      font-weight: 700;
      backdrop-filter: blur(8px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .student-card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 2rem;
      margin-bottom: 3rem;
    }

    .info-card {
      background: var(--glass-bg);
      backdrop-filter: blur(12px);
      border: 1px solid var(--glass-border);
      border-radius: 28px;
      padding: 2rem;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.03);
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .info-card:hover {
      transform: translateY(-10px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.08);
      background: rgba(255, 255, 255, 0.85);
    }

    .card-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 1.5rem;
    }

    .card-icon {
      width: 54px;
      height: 54px;
      border-radius: 18px;
      background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
      color: #059669;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .card-title {
      font-size: 1.2rem;
      font-weight: 800;
      color: #0f172a;
    }

    .data-row {
      display: flex;
      justify-content: space-between;
      padding: 1rem 0;
      border-bottom: 1px solid rgba(0, 0, 0, 0.04);
    }

    .data-label {
      color: var(--text-muted);
      font-weight: 600;
      font-size: 0.95rem;
    }

    .data-value {
      font-weight: 700;
      color: #0f172a;
    }

    .link-section {
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
      border-radius: 32px;
      padding: 2.5rem;
      border: 2px dashed #059669;
      position: relative;
    }

    .theme-input {
      padding: 16px 24px;
      border-radius: 16px;
      border: 2px solid #e2e8f0;
      font-size: 1rem;
      width: 100%;
      outline: none;
      transition: all 0.3s ease;
    }

    .theme-input:focus {
      border-color: #059669;
      box-shadow: 0 0 0 4px rgba(5, 150, 105, 0.1);
    }

    .theme-btn.primary {
      padding: 16px 32px;
      border-radius: 16px;
      font-weight: 700;
      background: linear-gradient(135deg, #059669 0%, #064e3b 100%);
      border: none;
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 10px 20px rgba(5, 150, 105, 0.2);
    }

    .theme-btn.primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 15px 30px rgba(5, 150, 105, 0.3);
    }

    .student-chip {
      padding: 1.25rem;
      border-radius: 20px;
      background: var(--glass-bg);
      backdrop-filter: blur(8px);
      border: 1px solid var(--glass-border);
      cursor: pointer;
      min-width: 220px;
      transition: all 0.3s ease;
    }

    .student-chip:hover {
      background: white;
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
    }

    @media (max-width: 1024px) {
      .sidebar {
        width: 85px;
      }

      .sidebar-brand,
      .nav-item span {
        display: none;
      }

      .main-content {
        margin-left: 85px;
      }
    }

    @media (max-width: 768px) {
      .main-content {
        padding: 1.5rem;
      }

      .student-profile {
        flex-direction: column;
        text-align: center;
        padding: 2rem;
      }

      .profile-img {
        width: 120px;
        height: 120px;
      }
    }
  </style>
</head>

<body>
  <div class="dashboard-layout">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <img src="/favicon.ico" alt="Logo" class="sidebar-logo">
        <span class="sidebar-brand">Shuleni Advantage</span>
      </div>

      <nav class="sidebar-nav">
        <a href="student_info_page.html" class="nav-item active">
          <i class="fas fa-th-large"></i>
          <span>Dashboard</span>
        </a>
        <a href="payments.html" class="nav-item">
          <i class="fas fa-credit-card"></i>
          <span>Payments</span>
        </a>
        <a href="settings.html" class="nav-item">
          <i class="fas fa-user-gear"></i>
          <span>Settings</span>
        </a>
      </nav>

      <div style="padding:1.5rem;">
        <a href="#" class="nav-item" id="logout-btn"
          style="background: rgba(239, 68, 68, 0.1); color: #fca5a5; border: 1px solid rgba(239, 68, 68, 0.2);">
          <i class="fas fa-power-off"></i>
          <span>Logout</span>
        </a>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <div class="top-bar">
        <div class="user-welcome">
          <h1>Parent Dashboard</h1>
          <p id="welcomeMsg" style="color:var(--text-muted); font-weight: 500; margin-top: 4px;">Welcome back to your
            school portal</p>
        </div>
        <div class="top-actions">
          <button class="theme-btn outline" id="refreshDataBtn">
            <i class="fas fa-rotate"></i> Refresh
          </button>
          <div class="user-avatar"
            style="width:52px; height:52px; background:linear-gradient(135deg, #059669 0%, #064e3b 100%); border-radius:18px; color:white; display:flex; align-items:center; justify-content:center; font-weight:800; font-size: 1.2rem; box-shadow: 0 8px 16px rgba(5, 150, 105, 0.2);">
            P
          </div>
        </div>
      </div>

      <div id="dashboardState" class="theme-card"
        style="padding:1rem;margin-bottom:2rem;display:none;text-align:center;"></div>

      <!-- Student Profile Hero -->
      <div id="studentContent" style="display:none;">
        <div class="student-profile">
          <img src="" alt="Student" class="profile-img" id="studentPhoto"
            onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iI2NjYyI+PHBhdGggZD0iTTEyLDEyQTUuNSw1LjUgMCwwLDAgMTcuNSw2LjVBNS41LDUuNSAwLDAsMCAxMiwxQTUuNSw1LjUgMCwwLDAgNi41LDYuNUE1LjUsNS41IDAsMCwwIDEyLDEyTTEyLDE0QzcuNTgsMTQgNCwxNS43OSA0LDE4VjIwSDIwVjE4QzIwLDE1Ljc5IDE2LjQyLDE0IDEyLDE0WiIvPjwvc3ZnPg=='">
          <div class="profile-details">
            <h2 id="studentNameDisplay">Student Name</h2>
            <p style="opacity:0.9;font-size:1.1rem;" id="studentSubtitle">Class | Admission</p>
            <div class="profile-badges">
              <span class="badge success" id="statusBadge">Active Student</span>
              <span class="badge warning" id="feeBadge">Fee Balance</span>
            </div>
          </div>
        </div>

        <div class="student-card-grid">
          <!-- Academic Info -->
          <div class="info-card">
            <div class="card-header">
              <div class="card-icon">
                <i class="fas fa-school"></i>
              </div>
              <span class="card-title">Academic Details</span>
            </div>
            <div class="data-row">
              <span class="data-label">School</span>
              <span class="data-value" id="schoolNameValue">—</span>
            </div>
            <div class="data-row">
              <span class="data-label">Class</span>
              <span class="data-value" id="infoClass">—</span>
            </div>
            <div class="data-row">
              <span class="data-label">Admission No</span>
              <span class="data-value" id="infoAdmission">—</span>
            </div>
            <div class="data-row">
              <span class="data-label">NEMIS</span>
              <span class="data-value" id="infoNemis">—</span>
            </div>
          </div>

          <!-- Fee Info -->
          <div class="info-card">
            <div class="card-header">
              <div class="card-icon">
                <i class="fas fa-coins"></i>
              </div>
              <span class="card-title">Fee Status</span>
            </div>
            <div class="data-row">
              <span class="data-label">Balance</span>
              <span class="data-value" id="feeBalanceValue" style="color:var(--danger);">—</span>
            </div>
            <div class="data-row">
              <span class="data-label">Next Review</span>
              <span class="data-value" id="nextReviewValue">—</span>
            </div>
            <div class="data-row">
              <span class="data-label">Meal Card</span>
              <span class="data-value" id="mealCardValue">—</span>
            </div>
          </div>

          <!-- Guardian Info -->
          <div class="info-card">
            <div class="card-header">
              <div class="card-icon">
                <i class="fas fa-user-shield"></i>
              </div>
              <span class="card-title">Guardian Info</span>
            </div>
            <div class="data-row">
              <span class="data-label">Name</span>
              <span class="data-value" id="guardianNameValue">—</span>
            </div>
            <div class="data-row">
              <span class="data-label">Phone</span>
              <span class="data-value" id="guardianPhoneValue">—</span>
            </div>
            <div class="data-row">
              <span class="data-label">Relation</span>
              <span class="data-value" id="guardianRelationshipValue">—</span>
            </div>
          </div>
        </div>

        <!-- Link Student Section -->
        <div class="link-section">
          <h3 style="color:var(--primary-dark);margin-bottom:0.5rem;">Link Another Student</h3>
          <p class="text-muted">Enter the admission number provided by the school to link another child to your account.
          </p>
          <form id="linkStudentsForm" class="link-form">
            <input type="text" id="linkAdmissionsInput" class="theme-input" placeholder="e.g. ST001, ST002" required>
            <button type="submit" class="theme-btn primary">
              <i class="fas fa-link"></i> Link Student
            </button>
          </form>
          <div id="linkStatus" style="margin-top:1rem;font-weight:600;"></div>
        </div>

        <!-- Student List (Chips) -->
        <div id="studentsList" style="margin-top:2rem;display:flex;gap:1rem;flex-wrap:wrap;"></div>
      </div>
    </main>
  </div>

  <script src="/runtime-config.js"></script>
  <script src="/shared/api-client.js"></script>
  <script>
    // Re-implementing logic with new UI IDs
    const dashboardState = document.getElementById('dashboardState');
    const studentContent = document.getElementById('studentContent');
    const studentsListEl = document.getElementById('studentsList');
    const linkForm = document.getElementById('linkStudentsForm');
    const linkInput = document.getElementById('linkAdmissionsInput');
    const linkStatus = document.getElementById('linkStatus');
    const refreshBtn = document.getElementById('refreshDataBtn');
    const logoutBtn = document.getElementById('logout-btn');

    let studentsCache = [];
    let activeAdmission = null;

    function setState(message, variant = 'info') {
      if (!dashboardState) return;
      if (!message) {
        dashboardState.style.display = 'none';
        dashboardState.textContent = '';
        return;
      }
      dashboardState.textContent = message;
      dashboardState.style.display = 'block';
      dashboardState.style.color = variant === 'error' ? 'var(--danger)' : 'var(--primary)';
      dashboardState.style.background = variant === 'error' ? '#fee2e2' : '#dcfce7';
    }

    function formatDate(value) {
      if (!value) return '—';
      try {
        return new Date(value).toLocaleDateString('en-US', {
          year: 'numeric', month: 'short', day: 'numeric'
        });
      } catch (error) { return value; }
    }

    function formatCurrency(value) {
      const num = Number(value || 0);
      return 'KES ' + num.toLocaleString();
    }

    function renderStudent(student) {
      if (!student) return;
      activeAdmission = (student.adm || student.admission || student.id || '').toUpperCase();
      const admission = activeAdmission;
      const className = student.class || student.cls || '—';
      const feeBalance = student.fee_balance ?? student.feeBalance ?? 0;
      const parentData = JSON.parse(localStorage.getItem('sv_parent_user') || '{}');

      document.getElementById('studentNameDisplay').textContent = student.name || 'Student Name';
      document.getElementById('studentSubtitle').textContent = `${className} | Admission: ${admission}`;

      // Badges
      const feeBadge = document.getElementById('feeBadge');
      if (feeBalance > 0) {
        feeBadge.className = 'badge warning';
        feeBadge.textContent = `Balance: ${formatCurrency(feeBalance)}`;
      } else {
        feeBadge.className = 'badge success';
        feeBadge.textContent = 'Fees Cleared';
      }

      document.getElementById('schoolNameValue').textContent = student.school_name || 'Shuleni Advantage';
      document.getElementById('infoClass').textContent = className;
      document.getElementById('infoAdmission').textContent = admission;
      document.getElementById('infoNemis').textContent = student.nemis || '—';

      document.getElementById('feeBalanceValue').textContent = formatCurrency(feeBalance);
      document.getElementById('nextReviewValue').textContent = formatDate(student.date_of_completion);
      document.getElementById('mealCardValue').textContent = student.meal_card_validity ? formatDate(student.meal_card_validity) : 'Not set';

      document.getElementById('guardianNameValue').textContent = student.parent_name || parentData.name || '—';
      document.getElementById('guardianPhoneValue').textContent = student.parent_phone || parentData.phone || '—';
      document.getElementById('guardianRelationshipValue').textContent = student.relationship || 'Parent';

      // Update chips
      document.querySelectorAll('.student-chip').forEach(chip => {
        chip.style.borderColor = chip.dataset.adm === admission ? 'var(--primary)' : 'var(--border)';
        chip.style.background = chip.dataset.adm === admission ? 'rgba(20,83,45,0.05)' : 'var(--bg-card)';
      });

      studentContent.style.display = 'block';
    }

    function renderStudentsList(students) {
      if (!studentsListEl) return;
      if (!students.length) {
        studentsListEl.innerHTML = '<p class="text-muted">No students linked yet.</p>';
        return;
      }

      studentsListEl.innerHTML = students.map(student => {
        const adm = (student.adm || student.admission || '').toUpperCase();
        return `
          <div class="student-chip" data-adm="${adm}" style="padding:1rem;border:1px solid var(--border);border-radius:12px;background:var(--bg-card);cursor:pointer;min-width:200px;transition:var(--transition);" onclick="selectStudent('${adm}')">
            <div style="font-weight:700;color:var(--primary-dark);">${student.name || 'Student'}</div>
            <div style="font-size:0.9rem;color:var(--text-muted);">${student.class || 'Class —'}</div>
          </div>
        `;
      }).join('');
    }

    window.selectStudent = function (adm) {
      const student = studentsCache.find(s => (s.adm || s.admission || '').toUpperCase() === adm);
      if (student) renderStudent(student);
    }

    async function loadStudentData(showToast = false) {
      try {
        setState('Loading your students…');
        // Ensure studentsAPI is available
        if (typeof studentsAPI === 'undefined') {
          throw new Error('API Client not loaded properly');
        }

        const students = await studentsAPI.getMyStudents();
        studentsCache = students || [];

        if (!studentsCache.length) {
          setState('No students linked associated with your account. Please link a student using the form below.');
          // Hide profile and grid, show link section
          document.querySelector('.student-profile').style.display = 'none';
          document.querySelector('.student-card-grid').style.display = 'none';
          document.querySelector('.link-section').style.display = 'block';
          // Ensure container is visible
          studentContent.style.display = 'block';
          return;
        }

        // Show content
        document.querySelector('.student-profile').style.display = 'flex';
        document.querySelector('.student-card-grid').style.display = 'grid';
        document.querySelector('.link-section').style.display = 'block';

        setState('');
        renderStudentsList(studentsCache);

        // Ensure container is visible
        studentContent.style.display = 'block';

        // Select student: either active one or first one
        let targetStudent = studentsCache[0];
        if (activeAdmission) {
          const found = studentsCache.find(s => (s.adm || s.admission || s.id || '').toUpperCase() === activeAdmission);
          if (found) targetStudent = found;
        }

        renderStudent(targetStudent);

        if (showToast && linkStatus) {
          linkStatus.textContent = 'Data refreshed.';
          linkStatus.style.color = 'var(--success)';
          setTimeout(() => { linkStatus.textContent = ''; }, 2000);
        }
      } catch (error) {
        console.error('Error:', error);
        setState('Unable to load students. Please try refreshing.', 'error');
        // Still show link section in case they need to link
        document.querySelector('.link-section').style.display = 'block';
      }
    }

    async function handleLinkSubmit(e) {
      e.preventDefault();
      const admissions = linkInput.value.split(',').map(s => s.trim().toUpperCase()).filter(Boolean);
      if (!admissions.length) return;

      const btn = linkForm.querySelector('button');
      const originalText = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Linking...';

      try {
        const summary = await parentsAPI.linkStudents(admissions);
        // Handle success/partial success
        linkStatus.textContent = 'Link attempt complete. Refreshing...';
        linkStatus.style.color = 'var(--success)';
        linkInput.value = '';
        await loadStudentData();
      } catch (err) {
        linkStatus.textContent = err.message || 'Failed to link.';
        linkStatus.style.color = 'var(--danger)';
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    }

    function logout() {
      if (confirm('Are you sure you want to log out?')) {
        localStorage.removeItem('sv_parent_token');
        localStorage.removeItem('sv_parent_user');
        window.location.href = 'parent_login_page.html';
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      // Check auth
      const token = localStorage.getItem('sv_parent_token');
      if (!token) {
        window.location.href = 'parent_login_page.html';
        return;
      }

      const userData = JSON.parse(localStorage.getItem('sv_parent_user') || '{}');
      if (userData.name) {
        document.getElementById('welcomeMsg').textContent = `Welcome back, ${userData.name.split(' ')[0]}`;
        document.querySelector('.user-avatar').textContent = userData.name.charAt(0).toUpperCase();
      }

      await loadStudentData();

      if (logoutBtn) logoutBtn.addEventListener('click', (e) => {
        e.preventDefault();
        logout();
      });

      if (refreshBtn) refreshBtn.addEventListener('click', () => loadStudentData(true));
      if (linkForm) linkForm.addEventListener('submit', handleLinkSubmit);
    });
  </script>
</body>

</html>