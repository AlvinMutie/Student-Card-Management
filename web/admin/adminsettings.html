<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Settings | Shuleni Advantage</title>
  <link rel="icon" href="/assets/maseno_logo.png" type="image/png">
  <link rel="stylesheet" href="/admin/shared-admin-styles.css">

  <script src="/admin/admin-layout.js"></script>
</head>

<body data-page="settings">
  <main class="main-content">
    <div class="content-wrapper">
      <div class="top-row">
        <div class="dashboard-header">
          <h2>Settings</h2>
          <div class="muted">Manage your profile and system configurations</div>
        </div>
        <div class="admin-section">
          <!-- Populated by admin-layout.js -->
        </div>
      </div>

      <div class="card">
        <h3>Admin Profile</h3>
        <div class="form-group">
          <div class="form-row">
            <div class="form-control">
              <label for="profileName">Full Name</label>
              <input id="profileName" placeholder="Enter your full name" value="Administrator">
            </div>
            <div class="form-control">
              <label for="profileEmail">Email Address</label>
              <input id="profileEmail" type="email" placeholder="Enter your email" value="admin@example.com">
            </div>
          </div>
          <button id="saveProfileBtn" class="btn btn-primary">
            <svg class="btn-icon" viewBox="0 0 24 24">
              <path
                d="M15,9H5V5H15M12,19A3,3 0 0,1 9,16A3,3 0 0,1 12,13A3,3 0 0,1 15,16A3,3 0 0,1 12,19M17,3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V7L17,3Z" />
            </svg>
            Save Profile
          </button>
          <div id="profileMessage" class="message"></div>
        </div>
      </div>

      <div class="card">
        <h3>User Password Recovery</h3>
        <p class="muted" style="margin-bottom: 15px;">Reset passwords for users who have forgotten their credentials.
        </p>

        <div class="form-group">
          <label>Find User</label>
          <div class="search-container">
            <svg class="search-icon" viewBox="0 0 24 24">
              <path
                d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z" />
            </svg>
            <input type="text" id="userSearch" class="search-input" placeholder="Search by name, email, or role...">
            <button class="clear-search" id="clearSearch">âœ•</button>
          </div>
          <div class="search-stats" id="searchStats">Showing all users</div>

          <label>Select User</label>
          <div class="user-list" id="userList">
            <div class="user-item" data-user="ST001" data-name="Alex Johnson" data-email="alex.johnson@student.edu"
              data-role="Student">
              <div class="user-info">
                <div>
                  <div class="user-name">Alex Johnson</div>
                  <div class="user-email">alex.johnson@student.edu</div>
                </div>
                <span class="user-role">Student</span>
              </div>
            </div>
            <div class="user-item" data-user="ST002" data-name="Sophia Garcia" data-email="sophia.garcia@student.edu"
              data-role="Student">
              <div class="user-info">
                <div>
                  <div class="user-name">Sophia Garcia</div>
                  <div class="user-email">sophia.garcia@student.edu</div>
                </div>
                <span class="user-role">Student</span>
              </div>
            </div>
            <div class="user-item" data-user="ST003" data-name="Emma Chen" data-email="emma.chen@student.edu"
              data-role="Student">
              <div class="user-info">
                <div>
                  <div class="user-name">Emma Chen</div>
                  <div class="user-email">emma.chen@student.edu</div>
                </div>
                <span class="user-role">Student</span>
              </div>
            </div>
            <div class="user-item" data-user="P001" data-name="Maria Garcia" data-email="maria.garcia@email.com"
              data-role="Parent">
              <div class="user-info">
                <div>
                  <div class="user-name">Maria Garcia</div>
                  <div class="user-email">maria.garcia@email.com</div>
                </div>
                <span class="user-role">Parent</span>
              </div>
            </div>
            <div class="user-item" data-user="P002" data-name="Robert Chen" data-email="robert.chen@email.com"
              data-role="Parent">
              <div class="user-info">
                <div>
                  <div class="user-name">Robert Chen</div>
                  <div class="user-email">robert.chen@email.com</div>
                </div>
                <span class="user-role">Parent</span>
              </div>
            </div>
            <div class="user-item" data-user="S001" data-name="Sarah Wilson" data-email="sarah.wilson@staff.edu"
              data-role="Teacher">
              <div class="user-info">
                <div>
                  <div class="user-name">Sarah Wilson</div>
                  <div class="user-email">sarah.wilson@staff.edu</div>
                </div>
                <span class="user-role">Teacher</span>
              </div>
            </div>
            <div class="user-item" data-user="S002" data-name="James Rodriguez" data-email="james.rodriguez@staff.edu"
              data-role="Teacher">
              <div class="user-info">
                <div>
                  <div class="user-name">James Rodriguez</div>
                  <div class="user-email">james.rodriguez@staff.edu</div>
                </div>
                <span class="user-role">Teacher</span>
              </div>
            </div>
            <div class="user-item" data-user="S003" data-name="Lisa Thompson" data-email="lisa.thompson@staff.edu"
              data-role="Administrator">
              <div class="user-info">
                <div>
                  <div class="user-name">Lisa Thompson</div>
                  <div class="user-email">lisa.thompson@staff.edu</div>
                </div>
                <span class="user-role">Administrator</span>
              </div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-control">
              <label for="recoveryMethod">Recovery Method</label>
              <select id="recoveryMethod">
                <option value="email">Send Reset Link via Email</option>
                <option value="temporary">Generate Temporary Password</option>
                <option value="manual">Manual Reset</option>
              </select>
            </div>
          </div>

          <div id="manualResetSection" style="display: none;">
            <div class="form-row">
              <div class="form-control">
                <label for="newPassword">New Password</label>
                <input id="newPassword" type="password" placeholder="Enter new password">
              </div>
              <div class="form-control">
                <label for="confirmPassword">Confirm Password</label>
                <input id="confirmPassword" type="password" placeholder="Confirm new password">
              </div>
            </div>
          </div>

          <div id="temporaryPasswordSection" style="display: none;">
            <div class="security-info">
              <h4 style="margin-bottom: 10px;">Temporary Password Security</h4>
              <div class="security-item">
                <svg class="security-icon" viewBox="0 0 24 24">
                  <path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z" />
                </svg>
                <span>Password will expire in 24 hours</span>
              </div>
              <div class="security-item">
                <svg class="security-icon" viewBox="0 0 24 24">
                  <path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z" />
                </svg>
                <span>User must change password on first login</span>
              </div>
              <div class="security-item">
                <svg class="security-icon" viewBox="0 0 24 24">
                  <path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z" />
                </svg>
                <span>Password will be automatically generated</span>
              </div>
            </div>
          </div>

          <button id="initiateRecoveryBtn" class="btn btn-primary" disabled>
            <svg class="btn-icon" viewBox="0 0 24 24">
              <path
                d="M12,17A2,2 0 0,0 14,15C14,13.89 13.1,13 12,13A2,2 0 0,0 10,15A2,2 0 0,0 12,17M18,8A2,2 0 0,1 20,10V20A2,2 0 0,1 18,22H6A2,2 0 0,1 4,20V10C4,8.89 4.9,8 6,8H7V6A5,5 0 0,1 12,1A5,5 0 0,1 17,6V8H18M12,3A3,3 0 0,0 9,6V8H15V6A3,3 0 0,0 12,3Z" />
            </svg>
            Initiate Password Recovery
          </button>
          <div id="recoveryMessage" class="message"></div>
        </div>
      </div>

      <div class="card">
        <h3>Security Settings</h3>
        <div class="form-group">
          <div class="toggle-label">
            <label for="twoFactorAuth">Two-Factor Authentication</label>
            <label class="toggle-switch">
              <input type="checkbox" id="twoFactorAuth">
              <span class="toggle-slider"></span>
            </label>
          </div>
          <div class="toggle-label">
            <label for="sessionTimeout">Session Timeout (30 minutes)</label>
            <label class="toggle-switch">
              <input type="checkbox" id="sessionTimeout" checked>
              <span class="toggle-slider"></span>
            </label>
          </div>
          <div class="toggle-label">
            <label for="passwordPolicy">Enforce Strong Password Policy</label>
            <label class="toggle-switch">
              <input type="checkbox" id="passwordPolicy" checked>
              <span class="toggle-slider"></span>
            </label>
          </div>
          <button id="saveSecurityBtn" class="btn btn-primary">
            <svg class="btn-icon" viewBox="0 0 24 24">
              <path
                d="M12,1L3,5V11C3,16.55 6.84,21.74 12,23C17.16,21.74 21,16.55 21,11V5L12,1M12,7C13.4,7 14.8,8.6 14.8,10V11.5C15.4,11.5 16,12.1 16,12.7V16.5C16,17.1 15.4,17.7 14.8,17.7H9.2C8.6,17.7 8,17.1 8,16.5V12.6C8,12 8.6,11.4 9.2,11.4V10C9.2,8.6 10.6,7 12,7M12,8.2C11.2,8.2 10.5,8.7 10.5,9.5V11.5H13.5V9.5C13.5,8.7 12.8,8.2 12,8.2Z" />
            </svg>
            Save Security Settings
          </button>
          <div id="securityMessage" class="message"></div>
        </div>
      </div>

      <div class="card">
        <h3>System Preferences</h3>
        <div class="form-group">
          <div class="form-row">
            <div class="form-control">
              <label for="language">Language</label>
              <select id="language">
                <option value="en">English</option>
                <option value="es">Spanish</option>
                <option value="fr">French</option>
              </select>
            </div>
            <div class="form-control">
              <label for="timezone">Timezone</label>
              <select id="timezone">
                <option value="est">Eastern Time (EST)</option>
                <option value="cst">Central Time (CST)</option>
                <option value="mst">Mountain Time (MST)</option>
                <option value="pst" selected>Pacific Time (PST)</option>
              </select>
            </div>
          </div>
          <button id="savePreferencesBtn" class="btn btn-primary">
            <svg class="btn-icon" viewBox="0 0 24 24">
              <path
                d="M17.9,17.39C17.64,16.59 16.89,16 16,16H15V13A1,1 0 0,0 14,12H8V10H10A1,1 0 0,0 11,9V7H13A2,2 0 0,0 15,5V4.59C17.93,5.77 20,8.64 20,12C20,14.08 19.2,15.97 17.9,17.39M11,19.93C7.05,19.44 4,16.08 4,12C4,11.38 4.08,10.78 4.21,10.21L9,15V16A2,2 0 0,0 11,18M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z" />
            </svg>
            Save Preferences
          </button>
          <div id="preferencesMessage" class="message"></div>
        </div>
      </div>
  </main>

  <!-- Confirmation Modal -->
  <div class="modal" id="confirmationModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Confirm Password Reset</h3>
        <button class="close-modal">&times;</button>
      </div>
      <p>Are you sure you want to reset the password for <strong id="confirmUserName">User Name</strong>?</p>
      <p class="muted" style="margin-top: 10px;">This action cannot be undone. The user will receive instructions to set
        a new password.</p>
      <div class="modal-actions">
        <button class="btn btn-secondary" id="cancelReset">Cancel</button>
        <button class="btn btn-primary" id="confirmReset">Confirm Reset</button>
      </div>
    </div>
  </div>

  <script src="../runtime-config.js"></script>
  <script src="../shared/api-client.js"></script>
  <script src="app-api.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // Authentication check
      ensureAuthRedirect();

      // Initialize settings page using app-api.js (for profile settings)
      if (typeof initSettingsPage === 'function') {
        initSettingsPage();
      }

      // Set admin info
      const adminEmail = localStorage.getItem('sv_admin_email') || 'admin';
      const adminInfoEl = document.getElementById('adminInfo');
      if (adminInfoEl) {
        adminInfoEl.textContent = `Welcome back, ${adminEmail.split('@')[0]}`;
      }

      // Logout functionality (using app-api.js function)
      function logout() {
        if (confirm('Are you sure you want to logout?')) {
          if (typeof doLogout === 'function') {
            doLogout();
          } else {
            localStorage.removeItem('sv_admin_token');
            localStorage.removeItem('sv_admin_email');
            window.location.href = '/index.html';
          }
        }
      }

      // Add event listeners to logout buttons
      const sidebarLogout = document.getElementById('sidebarLogout');
      const topLogout = document.getElementById('topLogout');
      if (sidebarLogout) sidebarLogout.addEventListener('click', logout);
      if (topLogout) topLogout.addEventListener('click', logout);

      // Profile save functionality (app-api.js handles this, but keeping for UI consistency)
      const saveProfileBtn = document.getElementById('saveProfileBtn');
      if (saveProfileBtn) {
        saveProfileBtn.addEventListener('click', function () {
          const nameEl = document.getElementById('profileName');
          const emailEl = document.getElementById('profileEmail');
          if (nameEl && emailEl) {
            const name = nameEl.value;
            const email = emailEl.value;

            if (!name || !email) {
              showMessage('profileMessage', 'Please fill in all required fields', 'error');
              return;
            }

            // app-api.js initSettingsPage already handles saving, but we can show a message
            showMessage('profileMessage', 'Profile updated successfully!', 'success');
          }
        });
      }

      // Search functionality
      const userSearch = document.getElementById('userSearch');
      const clearSearch = document.getElementById('clearSearch');
      const userList = document.getElementById('userList');
      const searchStats = document.getElementById('searchStats');
      const userItems = document.querySelectorAll('.user-item');

      userSearch.addEventListener('input', function () {
        const searchTerm = this.value.toLowerCase().trim();
        let visibleCount = 0;

        // Show/hide clear button based on search input
        clearSearch.style.display = searchTerm ? 'block' : 'none';

        // Filter users
        userItems.forEach(item => {
          const name = item.getAttribute('data-name').toLowerCase();
          const email = item.getAttribute('data-email').toLowerCase();
          const role = item.getAttribute('data-role').toLowerCase();

          if (name.includes(searchTerm) || email.includes(searchTerm) || role.includes(searchTerm)) {
            item.style.display = 'block';
            visibleCount++;
          } else {
            item.style.display = 'none';
          }
        });

        // Update search stats
        if (searchTerm) {
          searchStats.textContent = `Found ${visibleCount} user${visibleCount !== 1 ? 's' : ''} matching "${searchTerm}"`;
        } else {
          searchStats.textContent = `Showing all ${visibleCount} users`;
        }

        // Clear selection if selected user is no longer visible
        const selectedItem = document.querySelector('.user-item.selected');
        if (selectedItem && selectedItem.style.display === 'none') {
          selectedItem.classList.remove('selected');
          selectedUser = null;
          document.getElementById('initiateRecoveryBtn').disabled = true;
        }
      });

      // Clear search functionality
      clearSearch.addEventListener('click', function () {
        userSearch.value = '';
        userSearch.dispatchEvent(new Event('input'));
        userSearch.focus();
      });

      // User selection functionality
      let selectedUser = null;

      userItems.forEach(item => {
        item.addEventListener('click', function () {
          // Remove selected class from all items
          userItems.forEach(i => i.classList.remove('selected'));
          // Add selected class to clicked item
          this.classList.add('selected');
          selectedUser = this.getAttribute('data-user');

          // Enable the recovery button
          document.getElementById('initiateRecoveryBtn').disabled = false;
        });
      });

      // Recovery method change
      document.getElementById('recoveryMethod').addEventListener('change', function () {
        const method = this.value;
        document.getElementById('manualResetSection').style.display = 'none';
        document.getElementById('temporaryPasswordSection').style.display = 'none';

        if (method === 'manual') {
          document.getElementById('manualResetSection').style.display = 'block';
        } else if (method === 'temporary') {
          document.getElementById('temporaryPasswordSection').style.display = 'block';
        }
      });

      // Initiate recovery
      document.getElementById('initiateRecoveryBtn').addEventListener('click', function () {
        if (!selectedUser) {
          showMessage('recoveryMessage', 'Please select a user first', 'error');
          return;
        }

        const method = document.getElementById('recoveryMethod').value;
        const selectedUserElement = document.querySelector('.user-item.selected');
        const userName = selectedUserElement.querySelector('.user-name').textContent;

        // Show confirmation modal
        document.getElementById('confirmUserName').textContent = userName;
        document.getElementById('confirmationModal').style.display = 'flex';
      });

      // Modal functionality
      document.querySelector('.close-modal').addEventListener('click', closeModal);
      document.getElementById('cancelReset').addEventListener('click', closeModal);

      function closeModal() {
        document.getElementById('confirmationModal').style.display = 'none';
      }

      // Confirm reset
      document.getElementById('confirmReset').addEventListener('click', function () {
        const method = document.getElementById('recoveryMethod').value;
        const selectedUserElement = document.querySelector('.user-item.selected');
        const userName = selectedUserElement.querySelector('.user-name').textContent;

        // Validate manual password reset
        if (method === 'manual') {
          const newPassword = document.getElementById('newPassword').value;
          const confirmPassword = document.getElementById('confirmPassword').value;

          if (!newPassword || !confirmPassword) {
            showMessage('recoveryMessage', 'Please enter and confirm the new password', 'error');
            closeModal();
            return;
          }

          if (newPassword !== confirmPassword) {
            showMessage('recoveryMessage', 'Passwords do not match', 'error');
            closeModal();
            return;
          }

          if (newPassword.length < 8) {
            showMessage('recoveryMessage', 'Password must be at least 8 characters', 'error');
            closeModal();
            return;
          }
        }

        // Simulate API call
        setTimeout(() => {
          let message = '';
          if (method === 'email') {
            message = `Password reset email sent to ${userName}`;
          } else if (method === 'temporary') {
            message = `Temporary password generated for ${userName}`;
          } else if (method === 'manual') {
            message = `Password manually reset for ${userName}`;
            // Clear password fields
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
          }

          showMessage('recoveryMessage', message, 'success');
          closeModal();

          // Reset selection
          userItems.forEach(i => i.classList.remove('selected'));
          selectedUser = null;
          document.getElementById('initiateRecoveryBtn').disabled = true;
        }, 1000);
      });

      // Security settings save
      document.getElementById('saveSecurityBtn').addEventListener('click', function () {
        // Simulate API call
        setTimeout(() => {
          showMessage('securityMessage', 'Security settings updated successfully!', 'success');
        }, 1000);
      });

      // Preferences save
      document.getElementById('savePreferencesBtn').addEventListener('click', function () {
        // Simulate API call
        setTimeout(() => {
          showMessage('preferencesMessage', 'Preferences saved successfully!', 'success');
        }, 1000);
      });

      // Helper function to show messages
      function showMessage(elementId, text, type) {
        const element = document.getElementById(elementId);
        element.textContent = text;
        element.className = `message ${type}`;
        element.style.display = 'block';

        // Hide message after 5 seconds
        setTimeout(() => {
          element.style.display = 'none';
        }, 5000);
      }
    });
  </script>
</body>

</html>