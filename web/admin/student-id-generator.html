<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student ID Card Generator | Shuleni Advantage</title>
  <link rel="icon" href="/assets/maseno_logo.png" type="image/png">
  <link rel="stylesheet" href="/shared/portal-theme.css">
  <link rel="stylesheet" href="/admin/shared-admin-styles.css">
  
  <!-- Premium Typography -->
  <link
    href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600;800&family=Inter:wght@400;500;700&family=Montserrat:wght@500;600;800&family=Brush+Script+MT&display=swap"
    rel="stylesheet">
  <style>
    :root {
      --maseno-green: #004d2c;
      --shuleni-red: #e31e24;
      --primary-accent: var(--maseno-green);
      --secondary-accent: var(--shuleni-red);
      --text-on-accent: #ffffff;
      --house-mara: #b22222;
      --house-nakuru: #0047ab;
      --house-turkana: #008080;
      --house-baringo: #daa520;
    }

    .controls {
      background: var(--surface-card);
      padding: 24px;
      border-radius: 20px;
      box-shadow: var(--shadow-bento);
      margin-bottom: 30px;
      border: 1px solid var(--border-light);
      display: flex;
      flex-wrap: wrap;
      align-items: flex-end;
      gap: 16px;
    }

    .form-group {
      flex: 1;
      min-width: 250px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: var(--primary-color);
    }

    .form-group select {
      width: 100%;
      padding: 10px;
      border: 2px solid rgba(102, 126, 234, 0.3);
      border-radius: var(--border-radius);
      font-size: 1rem;
      background-color: white !important;
      color: var(--primary-color) !important;
      font-weight: 500;
    }

    .id-card-wrapper {
      display: flex;
      justify-content: center;
      margin-bottom: 30px;
    }

    .id-card {
      width: 5.5cm;
      height: 8.5cm;
      background-image: url('/assets/id_bg_2026.png');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      position: relative;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      overflow: hidden;
      border-radius: 8px;
      font-family: 'Inter', 'Arial', sans-serif;
    }

    .card-content {
      position: absolute;
      top: 15%;
      left: 50%;
      transform: translateX(-50%);
      width: 90%;
      display: flex;
      flex-direction: column;
      align-items: center;
      z-index: 10;
    }

    .student-photo {
      width: 2.3cm;
      height: 2.8cm;
      border-radius: 6px;
      overflow: hidden;
      border: 2.5px solid #004d2c;
      background: #ffffff;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      margin-bottom: 12px;
    }

    .student-photo img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .student-details {
      text-align: center;
      width: 100%;
    }

    .student-name {
      font-size: 14px;
      font-weight: 800;
      color: #004d2c;
      margin-bottom: 2px;
      text-transform: uppercase;
      letter-spacing: 0.2px;
    }

    .student-class {
      font-size: 9.5px;
      font-weight: 600;
      color: #333;
      margin-bottom: 0;
    }

    .student-adm {
      font-size: 9.5px;
      font-weight: 800;
      color: #004d2c;
      margin-top: 2px;
    }

    .qr-container {
      position: absolute;
      bottom: 8px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 3px;
    }

    .qr-code {
      width: 48px;
      height: 48px;
      border: 2px solid #000000;
      padding: 1px;
      background: white;
      border-radius: 2px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    }

    .qr-code img {
      width: 100%;
      height: 100%;
      image-rendering: pixelated;
      display: block;
    }

    .qr-label {
      background: #004d2c;
      color: white;
      padding: 1px 8px;
      font-size: 6px;
      font-weight: 800;
      border-radius: 3px;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      margin-top: 0;
      z-index: 5;
    }

    @media print {
      body {
        background: white !important;
        margin: 0 !important;
        padding: 0 !important;
      }

      .sidebar,
      .controls,
      .top-row,
      .no-print {
        display: none !important;
      }

      .main-content {
        padding: 0 !important;
        margin: 0 !important;
        background: white !important;
        width: 100% !important;
      }

      .id-card-wrapper {
        margin: 0 !important;
        padding: 10mm 0 !important;
        display: block !important;
      }

      .id-card {
        margin: 0 auto 10mm auto !important;
        box-shadow: none !important;
        border: 1px solid #ddd !important;
        page-break-inside: avoid !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }

      #batchIDCards {
        display: grid !important;
        grid-template-columns: repeat(2, 5.5cm) !important;
        gap: 10mm !important;
        justify-content: center !important;
        padding: 10mm !important;
        background: white !important;
      }

      #batchIDCards .id-card {
        margin: 0 !important;
        border: 1px solid #eee !important;
      }
    }
  </style>
  <script src="/admin/admin-layout.js"></script>
</head>

<body data-page="id-generator">
  <main class="main-content">
    <div class="content-wrapper">
      <div class="top-row no-print">
        <div class="dashboard-header">
          <h2>Student ID Card Generator</h2>
          <div class="muted">Generate and print professional school ID cards</div>
        </div>
        <div class="admin-section">
          <!-- Populated by admin-layout.js -->
        </div>
      </div>

      <div class="controls no-print">
        <div class="form-group">
          <label for="studentSelect">Select Student</label>
          <select id="studentSelect">
            <option value="">-- Select a student --</option>
          </select>
        </div>
        <button class="btn btn-primary" onclick="generateIDCard()">
          <svg style="width:18px;height:18px" viewBox="0 0 24 24">
            <path fill="currentColor"
              d="M11,9H13V7H11M12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M11,17H13V11H11V17Z" />
          </svg>
          Generate Card
        </button>
        <button class="btn btn-secondary" onclick="printIDCard()">
          <svg style="width:18px;height:18px" viewBox="0 0 24 24">
            <path fill="currentColor"
              d="M18,3H6V7H18M19,12A1,1 0 1,1 18,11A1,1 0 0,1 19,12M16,19H8V14H16M19,8H5A3,3 0 0,0 2,11V17H6V21H18V17H22V11A3,3 0 0,0 19,8Z" />
          </svg>
          Print Card
        </button>
        <button class="btn ghost" onclick="exportToPDF()">
          <svg style="width:18px;height:18px" viewBox="0 0 24 24">
            <path fill="currentColor"
              d="M14,2L20,8V20A2,2 0 0,1 18,22H6A2,2 0 0,1 4,20V4A2,2 0 0,1 6,2H14M18,20V9H13V4H6V20H18M13,13V18H15V13H13M10,10V18H12V10H10Z" />
          </svg>
          PDF Export
        </button>
        <button class="btn btn-primary" onclick="generateBatchIDCards()">
          <svg style="width:18px;height:18px" viewBox="0 0 24 24">
            <path fill="currentColor"
              d="M15,14V11H18V9L22,12.5L18,16V14H15M11,11H5V13H11V11M5,15H11V17H5V15M5,7H11V9H5V7Z" />
          </svg>
          Batch Multi
        </button>
      </div>

      <div class="id-card-wrapper" id="idCardWrapper" style="display: none;">
        <div id="idCard"></div>
      </div>

      <div id="batchIDCards"
        style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-top: 30px;">
      </div>

      <svg width="0" height="0" style="position: absolute;">
        <defs>
          <clipPath id="red-clip-final" clipPathUnits="objectBoundingBox">
            <path d="M0,0 L1,0 L0.25,0.85 Q0.15,0.95 0,1 L0,0 Z" />
          </clipPath>
          <clipPath id="green-clip-final" clipPathUnits="objectBoundingBox">
            <path d="M0.25,0.15 Q0.3,0 0.45,0 L1,0 L1,1 L0,1 L0.25,0.15 Z" />
          </clipPath>
        </defs>
      </svg>
    </div>
  </main>

  <script src="/runtime-config.js"></script>
  <script src="/shared/api-client.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    let allStudents = [];
    let selectedStudent = null;

    function getCardHTML(student, qrDataUrl) {
      const photoUrl = student.photo_url || 'data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 24 24\' fill=\'%23004d2c\'><path d=\'M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z\'/></svg>';

      return `
        <div class="id-card">
          <div class="card-content">
            <div class="student-photo">
              <img src="${photoUrl}" alt="${student.name || 'Student'}" onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=\\'http://www.w3.org/2000/svg\\' viewBox=\\'0 0 24 24\\' fill=\\'%23004d2c\\'><path d=\\'M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z\\'/></svg>'">
            </div>
            <div class="student-details">
              <h2 class="student-name">${student.name || 'N/A'}</h2>
              <p class="student-class">${student.class || 'N/A'} ${student.stream || ''}</p>
              <p class="student-adm">ADM NO: ${student.adm || 'N/A'}</p>
            </div>
          </div>
          <div class="qr-container">
            <div class="qr-code">
              <img src="${qrDataUrl}" alt="QR Code">
            </div>
            <div class="qr-label">SCAN ME</div>
          </div>
        </div>
      `;
    }

    async function loadData() {
      try {
        allStudents = await studentsAPI.getAll();
        const select = document.getElementById('studentSelect');
        allStudents.forEach(s => {
          const opt = document.createElement('option');
          opt.value = s.id;
          opt.textContent = `${s.adm} - ${s.name}`;
          select.appendChild(opt);
        });
      } catch (err) {
        console.error('Failed to load students:', err);
      }
    }

    async function generateQRCode(text) {
      if (!text) return '';
      return new Promise((resolve) => {
        const div = document.createElement('div');
        new QRCode(div, {
          text: text,
          width: 512,
          height: 512,
          correctLevel: QRCode.CorrectLevel.H
        });

        let attempts = 0;
        const check = setInterval(() => {
          const img = div.querySelector('img');
          const canvas = div.querySelector('canvas');
          if (img && img.src && img.src.length > 100) {
            clearInterval(check);
            resolve(img.src);
          } else if (canvas) {
            clearInterval(check);
            resolve(canvas.toDataURL('image/png'));
          }
          if (attempts++ > 20) {
            clearInterval(check);
            resolve('');
          }
        }, 50);
      });
    }

    async function generateIDCard() {
      const id = document.getElementById('studentSelect').value;
      if (!id) return alert('Select a student');
      selectedStudent = allStudents.find(s => s.id == id);
      const student = selectedStudent;
      const qr = await generateQRCode(student.adm || 'N/A');
      document.getElementById('idCard').innerHTML = getCardHTML(student, qr);
      document.getElementById('idCardWrapper').style.display = 'flex';
      document.getElementById('batchIDCards').innerHTML = '';
      document.getElementById('batchIDCards').style.display = 'none';
    }

    async function exportToPDF() {
      const card = document.querySelector('#idCard .id-card');
      if (!card) return alert('Generate a card first');
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
      const canvas = await html2canvas(card, { scale: 3, useCORS: true });
      const imgData = canvas.toDataURL('image/png');
      const x = (210 - 55) / 2;
      doc.addImage(imgData, 'PNG', x, 20, 55, 85);
      const fileName = `ID_Card_${selectedStudent.adm || selectedStudent.name}.pdf`;
      doc.save(fileName.replace(/\s+/g, '_'));
    }

    function printIDCard() {
      if (selectedStudent) {
        document.title = `ID_Card_${selectedStudent.adm || selectedStudent.name}`;
      }
      window.print();
    }

    async function generateBatchIDCards() {
      if (!allStudents.length) return alert('No students loaded yet');
      if (!confirm(`Generate ${allStudents.length} cards?`)) return;
      const container = document.getElementById('batchIDCards');
      container.innerHTML = '<div style="padding: 20px; text-align: center; grid-column: 1/-1;">Generating cards, please wait...</div>';
      container.style.display = 'grid';
      document.getElementById('idCardWrapper').style.display = 'none';
      let html = '';
      for (const s of allStudents) {
        const qr = await generateQRCode(s.adm || 'N/A');
        html += getCardHTML(s, qr);
      }
      container.innerHTML = html;
    }

    window.onload = loadData;
  </script>
</body>

</html>
