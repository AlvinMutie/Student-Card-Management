<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ID Generator | Shuleni Advantage</title>
  <link rel="icon" href="/assets/maseno_logo.png" type="image/png">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./admin-pelio.css">

  <style>
    /* Mockup ID Card Styles */
    .id-card-wrapper {
      display: flex;
      justify-content: center;
      padding: 40px;
      background: #1e293b;
      border-radius: 12px;
      min-height: 400px;
      align-items: center;
    }

    .p-id-card {
      width: 250px;
      height: 380px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
      position: relative;
      overflow: hidden;
      border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .p-id-card-header-wrap {
      position: relative;
      height: 80px;
      width: 100%;
    }

    .p-id-header-red {
      position: absolute;
      top: 0;
      left: 70%;
      width: 50px;
      height: 45px;
      background-color: #e31e24;
      z-index: 1;
      clip-path: polygon(10% 0, 100% 0, 42% 100%, 10% 100%);
    }

    .p-id-header-green {
      position: absolute;
      top: 0;
      left: 0;
      width: 85%;
      height: 50px;
      background-color: #004d2c;
      clip-path: polygon(0 0, 100% 0, 82% 100%, 0 100%);
      z-index: 2;
      padding: 10px 15px;
      box-sizing: border-box;
      color: white;
    }

    .p-id-header-green h4 {
      margin: 0;
      font-size: 11px;
      text-transform: uppercase;
      font-weight: 800;
      line-height: 1.2;
    }

    .p-id-header-green p {
      margin: 0;
      font-size: 6px;
      font-style: italic;
      opacity: 0.9;
    }

    .p-id-crest {
      position: absolute;
      top: 8px;
      right: 12px;
      width: 65px;
      height: 65px;
      background: white;
      border-radius: 50%;
      border: 3px solid #e0e0e0;
      box-shadow: inset 0 0 0 2px #e31e24, 0 4px 12px rgba(0, 0, 0, 0.2);
      z-index: 10;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 4px;
      overflow: hidden;
    }

    .p-id-crest img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      object-position: center;
    }

    .p-id-background-slant {
      position: absolute;
      top: 100px;
      bottom: 0;
      left: 0;
      right: 0;
      background-color: #f8fafc;
      clip-path: polygon(100% 0, 100% 100%, 0% 100%);
      z-index: 0;
      pointer-events: none;
    }

    .p-id-photo-frame {
      width: 90px;
      height: 90px;
      background: #f1f5f9;
      border: 3px solid white;
      border-radius: 50%;
      margin: 10px auto 10px;
      overflow: hidden;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      z-index: 5;
    }

    .p-id-photo-placeholder {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .p-id-name {
      text-align: center;
      margin: 5px 0 2px;
      font-size: 1.1rem;
      font-weight: 800;
      color: #004d2c;
      text-transform: uppercase;
      position: relative;
      z-index: 5;
    }

    .p-id-meta {
      text-align: center;
      font-size: 0.85rem;
      color: #004d2c;
      font-weight: 700;
      font-style: italic;
      position: relative;
      z-index: 5;
    }

    .p-id-qr-area {
      width: 55px;
      height: 55px;
      background: white;
      margin: 8px auto;
      padding: 5px;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
      z-index: 5;
    }

    .p-id-barcode {
      width: 150px;
      height: 20px;
      background: #000;
      margin: 5px auto;
      border-radius: 2px;
      opacity: 0.8;
      position: relative;
      z-index: 5;
    }

    .p-id-footer-wrap {
      position: absolute;
      bottom: 0;
      width: 100%;
      height: 45px;
      background: #004d2c;
      display: flex;
    }

    .p-id-footer-left {
      width: 30%;
      background: #e31e24;
      clip-path: polygon(0 0, 100% 0, 75% 100%, 0 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 8px;
    }

    .p-id-footer-right {
      width: 70%;
      padding-right: 15px;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      justify-content: center;
      color: white;
    }

    .p-id-footer-right h5 {
      margin: 0;
      font-size: 14px;
      font-family: 'Brush Script MT', cursive;
      line-height: 1;
    }

    .p-id-footer-right p {
      margin: 0;
      font-size: 8px;
      font-weight: 800;
      text-transform: uppercase;
    }

    .p-id-footer-right small {
      margin: 0;
      font-size: 4px;
      letter-spacing: 1px;
    }

    .p-id-notice {
      position: absolute;
      bottom: 48px;
      width: 100%;
      text-align: center;
      font-size: 5px;
      font-weight: 900;
      color: #004d2c;
      text-transform: uppercase;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .qr-label {
      background: #004d2c;
      color: white;
      padding: 1px 8px;
      font-size: 6px;
      font-weight: 800;
      border-radius: 3px;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      margin-top: 0;
      z-index: 5;
    }

    @media print {

      /* Hide all UI elements */
      .sidebar,
      .p-sidebar,
      .p-header,
      .controls-panel,
      .no-print,
      button,
      select,
      label,
      .p-btn,
      .admin-section,
      nav,
      header {
        display: none !important;
      }

      /* Reset body */
      body {
        background: white !important;
        margin: 0 !important;
        padding: 0 !important;
        color: black !important;
      }

      /* Reset main container */
      .p-main {
        margin: 0 !important;
        padding: 0 !important;
        width: 100% !important;
      }

      /* Reset card wrapper */
      .id-card-wrapper {
        background: white !important;
        padding: 0 !important;
        min-height: auto !important;
        display: block !important;
      }

      /* Style individual cards for print */
      .p-id-card {
        margin: 0 auto 5mm;
        page-break-inside: avoid;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15) !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
        color-adjust: exact !important;
      }

      /* Preserve all colors */
      .p-id-header-red {
        background-color: #e31e24 !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }

      .p-id-header-green {
        background-color: #004d2c !important;
        color: white !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }

      .p-id-crest {
        background: white !important;
        border: 3px solid #e0e0e0 !important;
        box-shadow: inset 0 0 0 2px #e31e24, 0 2px 6px rgba(0, 0, 0, 0.15) !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }

      .p-id-crest img {
        width: 100% !important;
        height: 100% !important;
      }

      .p-id-background-slant {
        background-color: #f8fafc !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }

      .p-id-photo-frame {
        background: #f1f5f9 !important;
        border: 3px solid white !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }

      .p-id-name,
      .p-id-meta {
        color: #004d2c !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }

      .p-id-barcode {
        background: #000 !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }

      .p-id-footer-wrap {
        background: #004d2c !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }

      .p-id-footer-left {
        background: #e31e24 !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }

      .p-id-footer-left img {
        width: 28px !important;
        height: 28px !important;
      }

      .p-id-footer-right {
        color: white !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }

      .p-id-notice {
        color: #004d2c !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }

      .p-main {
        padding: 10mm !important;
      }

      /* Batch cards grid layout */
      #batchIDCards {
        display: grid !important;
        grid-template-columns: repeat(2, 250px) !important;
        gap: 8mm !important;
        justify-content: center !important;
        padding: 0 !important;
      }

      /* Single card preview */
      #idCardPreview {
        display: flex !important;
        justify-content: center !important;
        padding: 0 !important;
      }
    }
  </style>
</head>

<body data-page="id-generator">

  <main class="p-main" style="flex-direction: row; align-items: flex-start; gap: 32px;">

    <!-- Controls Sidebar -->
    <div class="controls-panel no-print"
      style="width: 320px; background: white; padding: 24px; border-radius: 20px; border: 1px solid var(--p-border); position: sticky; top: 32px; flex-shrink: 0;">
      <h2 style="font-size: 1.25rem; font-weight: 800; margin-bottom: 24px;">Generator Controls</h2>

      <div style="margin-bottom: 24px;">
        <label style="display: block; font-weight: 600; margin-bottom: 8px;">Select Student</label>
        <select id="studentSelect"
          style="width: 100%; padding: 12px; border-radius: 12px; border: 1px solid var(--p-border); background: var(--p-bg);">
          <option value="">Loading students...</option>
        </select>
      </div>

      <div style="display: grid; gap: 12px; grid-template-columns: 1fr 1fr;">
        <button onclick="generateIDCard()"
          style="grid-column: 1/-1; padding: 16px; background: var(--p-blue); color: white; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
          <svg style="width:20px;height:20px" viewBox="0 0 24 24">
            <path fill="currentColor" d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z" />
          </svg>
          Generate Card
        </button>

        <button onclick="printIDCard()" class="p-btn p-btn-white" style="justify-content: center;">
          <svg style="width:18px;height:18px" viewBox="0 0 24 24">
            <path fill="currentColor"
              d="M18,3H6V7H18M19,12A1,1 0 1,1 18,11A1,1 0 0,1 19,12M16,19H8V14H16M19,8H5A3,3 0 0,0 2,11V17H6V21H18V17H22V11A3,3 0 0,0 19,8Z" />
          </svg>
          Print
        </button>

        <button onclick="exportToPDF()" class="p-btn p-btn-white" style="justify-content: center;">
          <svg style="width:18px;height:18px" viewBox="0 0 24 24">
            <path fill="currentColor"
              d="M14,2L20,8V20A2,2 0 0,1 18,22H6A2,2 0 0,1 4,20V4A2,2 0 0,1 6,2H14M18,20V9H13V4H6V20H18M13,13V18H15V13H13M10,10V18H12V10H10Z" />
          </svg>
          PDF
        </button>

        <button onclick="generateBatchIDCards()"
          style="grid-column: 1/-1; padding: 16px; background: var(--p-blue-soft); color: var(--p-blue); border: 2px solid var(--p-blue-soft); border-radius: 12px; font-weight: 800; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
          <svg style="width:20px;height:20px" viewBox="0 0 24 24">
            <path fill="currentColor"
              d="M15,14V11H18V9L22,12.5L18,16V14H15M11,11H5V13H11V11M5,15H11V17H5V15M5,7H11V9H5V7Z" />
          </svg>
          Batch Multi
        </button>
      </div>

      <div style="margin-top: 32px; padding-top: 24px; border-top: 1px solid var(--p-border);">
        <div class="admin-section">
          <!-- Populated by admin-layout.js -->
        </div>
      </div>
    </div>

    <!-- Preview Area -->
    <div style="flex: 1; display: flex; flex-direction: column; gap: 24px;">
      <header class="p-header">
        <div>
          <h1 class="p-page-title">ID Preview</h1>
          <p style="color: var(--p-text-muted);">Real-time card generation</p>
        </div>
      </header>

      <div class="id-card-wrapper" id="idCardWrapper" style="display: flex;">
        <div style="text-align: center; color: var(--p-text-light);">
          <svg style="width: 48px; height: 48px; opacity: 0.5; margin-bottom: 1rem;" viewBox="0 0 24 24">
            <path fill="currentColor"
              d="M4,4H20A2,2 0 0,1 22,6V18A2,2 0 0,1 20,20H4A2,2 0 0,1 2,18V6A2,2 0 0,1 4,4M4,6V18H20V6H4M12,9H14V11H12V9M12,13H14V15H12V13M8,9H10V11H8V9M8,13H10V15H8V13Z" />
          </svg>
          <p>Select a student to generate card</p>
        </div>
        <div id="idCard"></div>
      </div>

      <div id="batchIDCards"
        style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px;"></div>
    </div>

  </main>

  <!-- Scripts -->
  <script src="../runtime-config.js"></script>
  <script src="../shared/api-client.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="./admin-layout.js"></script>

  <script>
    // Existing Logic Ported
    let allStudents = [];
    let selectedStudent = null;

    function getCardHTML(student, qrDataUrl) {
      const photoUrl = student.photo_url || '';
      const photoPlaceholder = `<svg style="width:48px;height:48px; color: #004d2c;" viewBox="0 0 24 24">
        <path fill="currentColor" d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z" />
      </svg>`;

      return `
        <div class="p-id-card" style="animation: fadeInUp 0.5s ease;">
          <div class="p-id-card-header-wrap">
            <div class="p-id-header-red"></div>
            <div class="p-id-header-green">
              <h4>Shuleni Advantage</h4>
              <p>Perseverance shall win through</p>
            </div>
            <div class="p-id-crest">
              <img src="/assets/maseno_logo.png" style="width: 100%; height: 100%; object-fit: contain;">
            </div>
          </div>
          <div class="p-id-background-slant"></div>
          <div class="p-id-photo-frame">
            ${photoUrl ? `<img src="${photoUrl}" style="width: 100%; height: 100%; object-fit: cover;" alt="${student.name || 'Student'}">` : `<div class="p-id-photo-placeholder">${photoPlaceholder}</div>`}
          </div>
          <div class="p-id-name">${student.name || 'N/A'}</div>
          <div class="p-id-meta">${student.class || 'N/A'} ${student.stream || ''}</div>
          <div class="p-id-meta" style="font-size: 0.6rem; font-style: normal; margin-top: 2px;">ADM NO: ${student.adm || 'N/A'}</div>
          <div class="p-id-qr-area">
            <div class="p-id-qr-placeholder" style="width: 35px; height: 35px; ${qrDataUrl ? `background: url('${qrDataUrl}') center/cover;` : ''}"></div>
            <span style="font-size: 4px; font-weight: 900; color: black; margin-top: 2px;">SCAN ME</span>
          </div>
          <div class="p-id-barcode"></div>
          <div class="p-id-notice">Shuleni Advantage - 0738 934 812</div>
          <div class="p-id-footer-wrap">
            <div class="p-id-footer-left">
              <img src="/assets/hechlink_final.png" style="width: 100%; height: 100%; object-fit: contain; object-position: center;">
            </div>
            <div class="p-id-footer-right">
              <h5>Shuleni</h5>
              <p>Advantage<sup>+</sup></p>
              <small>SMART CARD</small>
            </div>
          </div>
        </div>
      `;
    }

    async function loadData() {
      try {
        allStudents = await studentsAPI.getAll();
        const select = document.getElementById('studentSelect');
        select.innerHTML = '<option value="">-- Select a student --</option>'; // Reset
        allStudents.forEach(s => {
          const opt = document.createElement('option');
          opt.value = s.id;
          opt.textContent = `${s.adm} - ${s.name}`;
          select.appendChild(opt);
        });
      } catch (err) {
        console.error('Failed to load students:', err);
      }
    }

    async function generateQRCode(text) {
      if (!text) return '';
      return new Promise((resolve) => {
        const div = document.createElement('div');
        new QRCode(div, {
          text: text,
          width: 512,
          height: 512,
          correctLevel: QRCode.CorrectLevel.H
        });

        let attempts = 0;
        const check = setInterval(() => {
          const img = div.querySelector('img');
          const canvas = div.querySelector('canvas');
          if (img && img.src && img.src.length > 100) {
            clearInterval(check);
            resolve(img.src);
          } else if (canvas) {
            clearInterval(check);
            resolve(canvas.toDataURL('image/png'));
          }
          if (attempts++ > 20) {
            clearInterval(check);
            resolve('');
          }
        }, 50);
      });
    }

    async function generateIDCard() {
      const id = document.getElementById('studentSelect').value;
      if (!id) return alert('Select a student');
      selectedStudent = allStudents.find(s => s.id == id);
      const student = selectedStudent;
      const qr = await generateQRCode(student.adm || 'N/A');

      document.querySelector('#idCardWrapper > div:first-child').style.display = 'none'; // Hide placeholder
      document.getElementById('idCard').innerHTML = getCardHTML(student, qr);
      document.getElementById('idCardWrapper').style.display = 'flex';

      document.getElementById('batchIDCards').innerHTML = '';
      document.getElementById('batchIDCards').style.display = 'none';
    }

    async function exportToPDF() {
      const card = document.querySelector('#idCard .id-card');
      if (!card) return alert('Generate a card first');
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
      const canvas = await html2canvas(card, { scale: 3, useCORS: true });
      const imgData = canvas.toDataURL('image/png');
      const x = (210 - 55) / 2;
      doc.addImage(imgData, 'PNG', x, 20, 55, 85);
      const fileName = `ID_Card_${selectedStudent.adm || selectedStudent.name}.pdf`;
      doc.save(fileName.replace(/\s+/g, '_'));
    }

    function printIDCard() {
      if (selectedStudent) {
        document.title = `ID_Card_${selectedStudent.adm || selectedStudent.name}`;
      }
      window.print();
    }

    async function generateBatchIDCards() {
      if (!allStudents.length) return alert('No students loaded yet');
      if (!confirm(`Generate ${allStudents.length} cards?`)) return;
      const container = document.getElementById('batchIDCards');
      container.innerHTML = '<div style="padding: 20px; text-align: center; grid-column: 1/-1;">Generating cards, please wait...</div>';
      container.style.display = 'grid';
      document.getElementById('idCardWrapper').style.display = 'none';

      let html = '';
      for (const s of allStudents) {
        const qr = await generateQRCode(s.adm || 'N/A');
        html += getCardHTML(s, qr);
      }
      container.innerHTML = html;
    }

    window.onload = loadData;
  </script>
</body>

</html>