<!DOCTYPE html>
<!-- ID_TEMPLATE_VERSION_2.3_SCAN_FIX -->
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student ID Card Generator | Shuleni Advantage</title>
  <link rel="icon" href="/favicon.ico" type="image/png">
  <link rel="stylesheet" href="/admin/shared-admin-styles.css">
  <link rel="stylesheet" href="/admin/admin-layout-utils.css">
  <!-- Premium Typography -->
  <link
    href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600;800&family=Inter:wght@400;500;700&family=Montserrat:wght@500;600;800&display=swap"
    rel="stylesheet">
  <style>
    :root {
      /* Default Maseno Theme */
      --maseno-green: #004d2c;
      --shuleni-red: #e31e24;

      /* Dynamic Theme Variables (Updated by JS) */
      --primary-accent: var(--maseno-green);
      --secondary-accent: var(--shuleni-red);
      --text-on-accent: #ffffff;

      /* House Colors */
      --house-mara: #b22222;
      /* Crimson */
      --house-nakuru: #0047ab;
      /* Cobalt */
      --house-turkana: #008080;
      /* Teal */
      --house-baringo: #daa520;
      /* Goldenrod */
    }

    /* Main Content */
    .main-content {
      flex: 1;
      padding: 40px 40px;
      overflow-y: auto;
      margin-left: 0;
      background: var(--beige-bg);
      min-height: 100vh;
      max-width: 2000px;
      margin: 0 auto;
    }

    .top-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 35px;
      padding-bottom: 20px;
      border-bottom: 2px solid rgba(74, 53, 16, 0.1);
    }

    /* Controls */
    .controls {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 255, 255, 0.98) 100%);
      padding: 25px;
      border-radius: var(--border-radius);
      box-shadow: 0 8px 32px rgba(102, 126, 234, 0.1);
      margin-bottom: 30px;
      border: 2px solid rgba(102, 126, 234, 0.2);
      display: flex;
      flex-wrap: wrap;
      align-items: flex-end;
      gap: 15px;
    }

    .form-group {
      margin-bottom: 0;
      flex: 1;
      min-width: 250px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: var(--primary-color);
    }

    .form-group select {
      width: 100%;
      padding: 10px;
      border: 2px solid rgba(102, 126, 234, 0.3);
      border-radius: var(--border-radius);
      font-size: 1rem;
      background-color: white !important;
      color: var(--primary-color) !important;
      font-weight: 500;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: all 0.3s ease;
      text-align: center;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white !important;
    }

    .btn-secondary {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%) !important;
      color: white !important;
    }

    /* ID Card Styles - Version 2 Portrait */
    /* ID Card Styles - Version 3 Premium */
    .id-card-wrapper {
      display: flex;
      flex-direction: column;
      gap: 40px;
      align-items: center;
      perspective: 1000px;
      margin-bottom: 30px;
    }

    .id-card {
      width: 5.5cm;
      height: 8.5cm;
      background-color: white;
      position: relative;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
      border-radius: 12px;
      overflow: hidden;
      text-align: left;
      font-family: 'Inter', sans-serif;
      transition: transform 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    /* Holographic Overlay Effect */
    .id-card::after {
      content: '';
      position: absolute;
      top: -150%;
      left: -150%;
      width: 400%;
      height: 400%;
      background: linear-gradient(135deg,
          rgba(255, 255, 255, 0) 0%,
          rgba(255, 255, 255, 0) 45%,
          rgba(255, 255, 255, 0.2) 50%,
          rgba(255, 255, 255, 0) 55%,
          rgba(255, 255, 255, 0) 100%);
      transform: rotate(0deg);
      transition: none;
      pointer-events: none;
      z-index: 20;
      opacity: 0;
    }

    .id-card:hover::after {
      opacity: 1;
      top: -50%;
      left: -50%;
      transition: all 1.5s ease;
    }

    /* Security Watermark */
    .watermark-layer {
      position: absolute;
      inset: 0;
      opacity: 0.04;
      pointer-events: none;
      z-index: 1;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Cpath d='M50 10 L80 30 L80 70 L50 90 L20 70 L20 30 Z' stroke='%23000' fill='none' stroke-width='2'/%3E%3C/svg%3E");
      background-size: 80px 80px;
    }

    .header-container {
      position: relative;
      height: 65px;
      width: 100%;
    }

    .header-red-accent {
      position: absolute;
      top: 0;
      left: 70%;
      width: 50px;
      height: 45px;
      background-color: var(--secondary-accent);
      z-index: 1;
      clip-path: polygon(10% 0, 100% 0, 42% 100%, 10% 100%);
    }

    .header-green-main {
      position: absolute;
      top: 0;
      left: 0;
      width: 85%;
      height: 50px;
      background-color: var(--primary-accent);
      clip-path: polygon(0 0, 100% 0, 82% 100%, 0 100%);
      z-index: 2;
      padding: 8px 12px;
      box-sizing: border-box;
      color: var(--text-on-accent);
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .header-green-main h1 {
      margin: 0;
      font-family: 'Cinzel', serif;
      font-size: 11px;
      text-transform: uppercase;
      font-weight: 800;
      color: var(--text-on-accent) !important;
      letter-spacing: 0.5px;
    }

    .header-green-main p {
      margin: 0;
      font-size: 6px;
      font-style: italic;
      color: var(--text-on-accent) !important;
      font-family: 'Inter', sans-serif;
    }

    .logo-crest {
      position: absolute;
      top: 8px;
      right: 12px;
      width: 45px;
      height: 45px;
      background: white;
      border-radius: 50%;
      border: 1px solid #eee;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1), inset 0 0 0 1.5px var(--secondary-accent);
      z-index: 10;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .background-slant {
      position: absolute;
      top: 100px;
      bottom: 0;
      left: 0;
      right: 0;
      background-color: #f4f4f4;
      clip-path: polygon(100% 0, 100% 100%, 0% 100%);
      z-index: 0;
    }

    .id-card-content {
      position: relative;
      z-index: 5;
      text-align: center;
      margin-top: 5px;
      height: 180px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .photo-frame {
      width: 2.3cm;
      height: 3.0cm;
      border-radius: 6px;
      overflow: hidden;
      border: 2px solid white;
      box-shadow: 0 0 0 1px #eee, 0 4px 10px rgba(0, 0, 0, 0.1), inset 0 0 10px rgba(0, 0, 0, 0.05);
      background: #f8fafc;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .student-name {
      color: var(--primary-accent);
      margin: 8px 0 2px 0;
      font-size: 13px;
      font-weight: 800;
      font-family: 'Montserrat', sans-serif;
      text-transform: uppercase;
      letter-spacing: -0.2px;
    }

    .grade-bar {
      border-bottom: 1.5px solid var(--secondary-accent);
      margin-bottom: 2px;
      padding: 0 5px;
    }

    .grade-text {
      color: var(--primary-accent);
      margin: 0;
      font-size: 9px;
      font-weight: 700;
      font-style: italic;
      font-family: 'Inter', sans-serif;
    }

    .adm-text {
      margin: 0;
      font-size: 7px;
      color: #333;
      font-weight: bold;
    }

    .qr-container {
      margin-top: 5px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .qr-box {
      width: 65px;
      height: 65px;
      border: 1px solid #000;
      padding: 3px;
      background: white;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .qr-box img {
      width: 100% !important;
      height: 100% !important;
      image-rendering: pixelated;
    }

    .scan-me {
      background: black;
      color: white;
      padding: 1px 4px;
      font-size: 5px;
      font-weight: bold;
      margin-top: -3px;
    }

    .footer {
      position: absolute;
      bottom: 0;
      width: 100%;
    }

    .footer-notice {
      text-align: center;
      font-size: 4px;
      color: var(--primary-accent);
      font-weight: 800;
      padding-bottom: 2px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .footer-branding {
      height: 45px;
      display: flex;
      position: relative;
    }

    .footer-red-part {
      position: absolute;
      left: 0;
      bottom: 0;
      width: 28%;
      height: 100%;
      background-color: var(--secondary-accent);
      clip-path: url(#red-clip-final);
      z-index: 2;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .footer-green-part {
      position: absolute;
      right: 0;
      bottom: 0;
      width: 78%;
      height: 100%;
      background-color: var(--primary-accent);
      clip-path: url(#green-clip-final);
      z-index: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: flex-end;
      padding-right: 12px;
      color: var(--text-on-accent);
    }

    .shuleni-text {
      font-size: 20px;
      font-family: 'Brush Script MT', cursive;
      line-height: 0.7;
    }

    .advantage-text {
      font-size: 11px;
      font-weight: bold;
    }

    .smart-card-text {
      font-size: 5px;
      letter-spacing: 2px;
      text-transform: uppercase;
    }

    /* Print Styles */
    @media print {

      .sidebar,
      .controls,
      .top-row,
      .no-print {
        display: none !important;
      }

      .main-content {
        padding: 0;
        margin: 0;
      }

      .id-card {
        margin: 0 auto;
        page-break-inside: avoid;
        border: 1px solid #ddd;
      }

      #batchIDCards {
        display: grid !important;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
      }
    }

    /* Cropping Modal Styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      overflow-y: auto;
    }

    .modal-content {
      background-color: #fefefe;
      margin: 5% auto;
      padding: 20px;
      border-radius: 15px;
      width: 80%;
      max-width: 600px;
      box-shadow: 0 5px 30px rgba(0, 0, 0, 0.3);
    }

    .crop-container {
      width: 100%;
      max-height: 400px;
      margin-bottom: 20px;
      background: #eee;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
  </style>
</head>

<body>
  <div class="sidebar">
    <div class="brand">
      <img src="../favicon.ico" alt="Shuleni Advantage Logo" class="brand-icon" style="filter:none;">
      <h1>Shuleni Advantage</h1>
    </div>
    <ul class="nav-links">
      <li><a href="admindashboard.html"><svg class="nav-icon" viewBox="0 0 24 24">
            <path d="M10,20V14H14V20H19V12H22L12,3L2,12H5V20H10Z" />
          </svg><span>Dashboard</span></a></li>
      <li><a href="students.html"><svg class="nav-icon" viewBox="0 0 24 24">
            <path
              d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z" />
          </svg><span>Students</span></a></li>
      <li><a href="parents.html"><svg class="nav-icon" viewBox="0 0 24 24">
            <path
              d="M16 17V19H2V17S2 13 9 13 16 17 16 17M12.5 7.5A3.5 3.5 0 1 0 9 11A3.5 3.5 0 0 0 12.5 7.5M15.94 13A5.32 5.32 0 0 1 18 17V19H22V17S22 13.37 15.94 13M15 4A3.39 3.39 0 0 0 13.07 4.59A5 5 0 0 1 13.07 10.41A3.39 3.39 0 0 0 15 11A3.5 3.5 0 0 0 15 4Z" />
          </svg><span>Parents</span></a></li>
      <li><a href="staff.html"><svg class="nav-icon" viewBox="0 0 24 24">
            <path
              d="M21.1,12.5L22.5,13.91L15.97,20.5L12.5,17L13.9,15.59L15.97,17.67L21.1,12.5M10,17L13,20H3V18C3,15.79 6.58,14 11,14L12.89,14.11L10,17M11,4A4,4 0 0,1 15,8A4,4 0 0,1 11,12A4,4 0 0,1 7,8A4,4 0 0,1 11,4Z" />
          </svg><span>Staff</span></a></li>
      <li><a href="visitors.html"><svg class="nav-icon" viewBox="0 0 24 24">
            <path
              d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z" />
          </svg><span>Visitors</span></a></li>
      <li><a href="student-id-generator.html" class="active"><svg class="nav-icon" viewBox="0 0 24 24">
            <path
              d="M14,21H10V19H14M17.71,5.29L19.79,7.37L18.37,8.79L16.29,6.71M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,8A4,4 0 0,1 16,12A4,4 0 0,1 12,16A4,4 0 0,1 8,12A4,4 0 0,1 12,8M12,10A2,2 0 0,0 10,12A2,2 0 0,0 12,14A2,2 0 0,0 14,12A2,2 0 0,0 12,10Z" />
          </svg><span>ID Generator</span></a></li>
      <li><a href="adminsettings.html"><svg class="nav-icon" viewBox="0 0 24 24">
            <path
              d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.22,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.22,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.68 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z" />
          </svg><span>Settings</span></a></li>
    </ul>
    <div class="logout-section">
      <button class="logout-btn" data-logout>
        <svg class="logout-icon" viewBox="0 0 24 24">
          <path
            d="M16,17V14H9V10H16V7L21,12L16,17M14,2A2,2 0 0,1 16,4V6H14V4H5V20H14V18H16V20A2,2 0 0,1 14,22H5A2,2 0 0,1 3,20V4A2,2 0 0,1 5,2H14Z" />
        </svg>
        <span>Log Out</span>
      </button>
    </div>
  </div>

  <main class="main-content">
    <div class="top-row">
      <h1>Student ID Card Generator</h1>
      <div id="adminInfo">Welcome, Admin</div>
    </div>

    <div class="controls">
      <div class="form-group">
        <label for="studentSelect">Select Student</label>
        <select id="studentSelect" onchange="enablePhotoAdjustment()">
          <option value="">-- Select a student --</option>
        </select>
      </div>
      <button class="btn btn-primary" onclick="generateIDCard()">Generate ID Card</button>
      <button class="btn btn-secondary" onclick="printIDCard()">Print ID Card</button>
      <button class="btn btn-secondary" onclick="exportToPDF()">Download PDF</button>
      <button class="btn btn-secondary" onclick="generateBatchIDCards()">Batch Generation</button>
    </div>

    <div class="id-card-container" id="idCardContainer" style="display: none;">
      <div class="id-card" id="idCard"></div>
    </div>

    <div id="batchIDCards"
      style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-top: 30px;">
    </div>

    <svg width="0" height="0" style="position: absolute;">
      <defs>
        <clipPath id="red-clip-final" clipPathUnits="objectBoundingBox">
          <path d="M0,0 L1,0 L0.25,0.85 Q0.15,0.95 0,1 L0,0 Z" />
        </clipPath>
        <clipPath id="green-clip-final" clipPathUnits="objectBoundingBox">
          <path d="M0.25,0.15 Q0.3,0 0.45,0 L1,0 L1,1 L0,1 L0.25,0.15 Z" />
        </clipPath>
      </defs>
    </svg>
  </main>

  <script src="../runtime-config.js"></script>
  <script src="../shared/api-client.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    let allStudents = [];
    let selectedStudent = null;

    // Helper to generate the card HTML (Double Sided)
    function getCardHTML(student, qrDataUrl) {
      // Determine House Theme
      let houseName = (student.house || 'Maseno').toLowerCase();
      let primary = 'var(--maseno-green)';
      let secondary = 'var(--shuleni-red)';

      if (houseName.includes('mara')) { primary = 'var(--house-mara)'; secondary = '#ffd700'; }
      else if (houseName.includes('nakuru')) { primary = 'var(--house-nakuru)'; secondary = '#c0c0c0'; }
      else if (houseName.includes('turkana')) { primary = 'var(--house-turkana)'; secondary = '#ffd700'; }
      else if (houseName.includes('baringo')) { primary = 'var(--house-baringo)'; secondary = '#0047ab'; }

      const themeStyle = `style="--primary-accent: ${primary}; --secondary-accent: ${secondary};"`;

      return `
        <div class="id-card-wrapper">
          <!-- FRONT SIDE -->
          <div class="id-card" ${themeStyle}>
            <div class="watermark-layer"></div>
            <div class="header-container">
              <div class="header-red-accent"></div>
              <div class="header-green-main">
                <h1>MASENO SCHOOL</h1>
                <p>Perseverance shall win through</p>
              </div>
              <div class="logo-crest">
                <img src="/favicon.ico" alt="Crest" style="width: 80%; object-fit: contain;">
              </div>
            </div>
            
            <div class="background-slant"></div>

            <div class="id-card-content">
              <div class="photo-frame">
                <img id="card-photo-${student.id}" src="${student.photo_url || '/assets/placeholder-student.png'}" style="width:100%; height:100%; object-fit:cover;" onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 24 24\' fill=\'%2394a3b8\'><path d=\'M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z\'/></svg>'">
              </div>

              <h2 class="student-name">${student.name || 'N/A'}</h2>
              
              <div class="grade-bar">
                <p class="grade-text">${student.class || 'N/A'} ${student.stream || ''}</p>
              </div>
              <p class="adm-text" style="font-family: 'Montserrat', sans-serif;">ADM NO: ${student.adm || 'N/A'}</p>

              <div class="qr-container">
                <div class="qr-box">
                  <img src="${qrDataUrl}" alt="QR">
                </div>
                <div class="scan-me">SCAN ME</div>
              </div>
            </div>

            <div class="footer">
              <div class="footer-notice">MASENO SCHOOL. - 0738 934 812 / 0713 715 956</div>
              <div class="footer-branding">
                <div class="footer-red-part">
                  <img src="/favicon.ico" style="width:15px; height:15px; filter:brightness(0) invert(1);">
                </div>
                <div class="footer-green-part">
                  <div class="shuleni-text">Shuleni</div>
                  <div class="advantage-text">Advantage<sup>+</sup></div>
                  <div class="smart-card-text">Smart Card</div>
                </div>
              </div>
            </div>
          </div>

          <!-- BACK SIDE -->
          <div class="id-card" ${themeStyle}>
            <div class="watermark-layer"></div>
            <div style="padding: 20px; font-size: 8px; color: #444; height: 100%; display: flex; flex-direction: column; justify-content: space-between;">
              <div style="text-align: center;">
                <h3 style="font-family: 'Cinzel', serif; color: var(--primary-accent); margin-bottom: 5px; font-size: 10px;">ID Card Rules</h3>
                <div style="width: 30px; height: 2px; background: var(--secondary-accent); margin: 0 auto 15px;"></div>
                <ul style="text-align: left; padding-left: 15px; line-height: 1.6; list-style-type: circle;">
                  <li>This card is the property of Maseno School.</li>
                  <li>It must be carried at all times within school premises.</li>
                  <li>Loss of card must be reported immediately to the headteacher.</li>
                  <li>Replacement fee is charged for lost or damaged cards.</li>
                  <li>This card is non-transferable.</li>
                </ul>
              </div>

              <div style="background: #f8fafc; padding: 10px; border-radius: 8px; border: 1px dashed var(--primary-accent); text-align: center;">
                 <p style="font-weight: bold; margin-bottom: 4px; color: var(--primary-accent);">RETURN ADDRESS</p>
                 <p>P.O. BOX 1, Maseno, Kenya</p>
                 <p>Tel: 0738 934 812</p>
              </div>

              <div style="text-align: center; border-top: 1px solid #eee; padding-top: 10px;">
                <p style="font-style: italic; font-size: 7px; color: #888;">"Perseverance shall win through"</p>
                <div style="margin-top: 5px; opacity: 0.6;">
                  <img src="/favicon.ico" style="width: 25px; filter: grayscale(1);">
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    async function loadData() {
      try {
        allStudents = await studentsAPI.getAll();
        const select = document.getElementById('studentSelect');
        allStudents.forEach(s => {
          const opt = document.createElement('option');
          opt.value = s.id;
          opt.textContent = `${s.adm} - ${s.name}`;
          select.appendChild(opt);
        });
      } catch (e) {
        console.error('FAILED TO LOAD STUDENTS', e);
      }
    }

    async function generateQRCode(text) {
      if (!text) return '';
      return new Promise((resolve) => {
        const div = document.createElement('div');
        // Increase resolution and set High error correction level for better scanning
        new QRCode(div, {
          text: text,
          width: 256,
          height: 256,
          colorDark: "#000000",
          colorLight: "#ffffff",
          correctLevel: QRCode.CorrectLevel.H
        });

        // Wait for image generation
        let checkCount = 0;
        const checkImage = setInterval(() => {
          const img = div.querySelector('img');
          const canvas = div.querySelector('canvas');
          if (img && img.src && img.src.length > 100) {
            clearInterval(checkImage);
            resolve(img.src);
          } else if (canvas) {
            clearInterval(checkImage);
            resolve(canvas.toDataURL('image/png'));
          }

          if (checkCount++ > 20) {
            clearInterval(checkImage);
            resolve('');
          }
        }, 50);
      });
    }

    async function generateIDCard() {
      const id = document.getElementById('studentSelect').value;
      if (!id) return alert('Select a student');
      selectedStudent = allStudents.find(s => s.id == id);
      const student = selectedStudent;
      const qr = await generateQRCode(student.adm);

      document.getElementById('idCard').innerHTML = getCardHTML(student, qr);
      document.getElementById('idCardContainer').style.display = 'flex';
      document.getElementById('batchIDCards').innerHTML = '';
    }

    function enablePhotoAdjustment() {
      const id = document.getElementById('studentSelect').value;
      if (id) {
        selectedStudent = allStudents.find(s => s.id == id);
      } else {
        selectedStudent = null;
      }
    }

    async function exportToPDF() {
      const wrapper = document.querySelector('.id-card-wrapper');
      if (!wrapper) return alert('Generate a card first');

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({
        orientation: 'p',
        unit: 'mm',
        format: 'a4'
      });

      const cards = wrapper.querySelectorAll('.id-card');

      // Captured Front
      const canvasFront = await html2canvas(cards[0], { scale: 3 });
      const imgFront = canvasFront.toDataURL('image/png');

      // Captured Back
      const canvasBack = await html2canvas(cards[1], { scale: 3 });
      const imgBack = canvasBack.toDataURL('image/png');

      // Page 1: Front (Centered)
      doc.addImage(imgFront, 'PNG', 77.5, 20, 55, 85);

      // Page 2: Back (Centered)
      doc.addPage();
      doc.addImage(imgBack, 'PNG', 77.5, 20, 55, 85);

      doc.save(`ID_Card_${selectedStudent.adm}.pdf`);
    }

    async function generateBatchIDCards() {
      if (!confirm(`Generate ${allStudents.length} cards?`)) return;
      const container = document.getElementById('batchIDCards');
      container.innerHTML = 'Generating...';
      document.getElementById('idCardContainer').style.display = 'none';

      let html = '';
      for (const s of allStudents) {
        const qr = await generateQRCode(s.adm);
        html += `<div class="id-card" style="margin-bottom:20px;">${getCardHTML(s, qr)}</div>`;
      }
      container.innerHTML = html;
    }

    function printIDCard() { window.print(); }

    window.onload = loadData;
  </script>
</body>

</html>