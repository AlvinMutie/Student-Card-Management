<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student ID Card Generator | Shuleni Advantage</title>
  <link rel="icon" href="/favicon.ico" type="image/png">
  <link rel="stylesheet" href="/admin/shared-admin-styles.css">
  <link rel="stylesheet" href="/admin/admin-layout-utils.css">
  :root {
  --maseno-green: #004d2c;
  --shuleni-red: #e31e24;
  }



  /* Main Content */
  .main-content {
  flex: 1;
  padding: 40px 40px;
  overflow-y: auto;
  margin-left: 0;
  background: var(--beige-bg);
  min-height: 100vh;
  max-width: 2000px;
  margin: 0 auto;
  }

  .top-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 35px;
  padding-bottom: 20px;
  border-bottom: 2px solid rgba(74, 53, 16, 0.1);
  }

  .top-row h1,
  .top-row h2 {
  font-size: 2rem;
  color: var(--primary-color);
  font-weight: 700;
  letter-spacing: -0.5px;
  }

  .admin-section {
  display: flex;
  align-items: center;
  gap: 15px;
  }

  #adminInfo {
  background: linear-gradient(135deg, white 0%, #fefefe 100%);
  padding: 10px 20px;
  border-radius: 25px;
  box-shadow: var(--box-shadow);
  font-size: 0.95rem;
  color: var(--primary-color);
  font-weight: 500;
  border: 1px solid rgba(74, 53, 16, 0.1);
  }

  .logout-btn-top {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 10px 20px;
  background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%) !important;
  color: white !important;
  border: none !important;
  border-radius: 25px;
  font-size: 0.9rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
  }

  .logout-btn-top:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(220, 38, 38, 0.4);
  background: linear-gradient(135deg, #b91c1c 0%, #dc2626 100%) !important;
  }

  .logout-icon-top {
  width: 16px;
  height: 16px;
  fill: currentColor;
  }

  .page-header {
  margin-bottom: 30px;
  }

  .page-header h1 {
  color: var(--primary-color);
  font-size: 2rem;
  margin-bottom: 10px;
  font-weight: 700;
  }

  .page-header p {
  color: #666;
  }

  /* Controls */
  .controls {
  background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 255, 255, 0.98) 100%);
  padding: 25px;
  border-radius: var(--border-radius);
  box-shadow: 0 8px 32px rgba(102, 126, 234, 0.1);
  margin-bottom: 30px;
  border: 2px solid rgba(102, 126, 234, 0.2);
  display: flex;
  flex-wrap: wrap;
  align-items: flex-end;
  gap: 15px;
  }

  .form-group {
  margin-bottom: 0;
  flex: 1;
  min-width: 250px;
  }

  .form-group label {
  display: block;
  margin-bottom: 5px;
  font-weight: 500;
  color: var(--primary-color);
  }

  .form-group input,
  .form-group select {
  width: 100%;
  padding: 10px;
  border: 2px solid rgba(102, 126, 234, 0.3);
  border-radius: var(--border-radius);
  font-size: 1rem;
  background-color: white !important;
  color: var(--primary-color) !important;
  font-weight: 500;
  transition: all 0.3s ease;
  }

  .form-group input:focus,
  .form-group select:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }

  .form-group select option {
  background-color: white !important;
  color: var(--primary-color) !important;
  padding: 10px;
  }

  .btn {
  padding: 12px 24px;
  border: none;
  border-radius: var(--border-radius);
  cursor: pointer;
  font-size: 1rem;
  font-weight: 600;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  display: inline-block;
  min-width: 150px;
  text-align: center;
  }

  .btn:hover {
  transform: translateY(-3px) scale(1.02);
  }

  .btn:active {
  transform: translateY(-1px) scale(0.98);
  }

  .btn-primary {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white !important;
  box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
  border: none;
  }

  .btn-primary:hover {
  box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
  background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
  transform: translateY(-2px);
  }

  .btn-secondary {
  background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%) !important;
  color: white !important;
  border: none !important;
  box-shadow: 0 4px 15px rgba(240, 147, 251, 0.3);
  }

  .btn-secondary:hover {
  background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%) !important;
  color: white !important;
  box-shadow: 0 8px 25px rgba(240, 147, 251, 0.4);
  transform: translateY(-2px);
  }

  .btn-secondary:nth-of-type(3) {
  background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%) !important;
  box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
  }

  .btn-secondary:nth-of-type(3):hover {
  background: linear-gradient(135deg, #00f2fe 0%, #4facfe 100%) !important;
  box-shadow: 0 8px 25px rgba(79, 172, 254, 0.4);
  }

  .btn-secondary:nth-of-type(4) {
  background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%) !important;
  box-shadow: 0 4px 15px rgba(67, 233, 123, 0.3);
  }

  .btn-secondary:nth-of-type(4):hover {
  background: linear-gradient(135deg, #38f9d7 0%, #43e97b 100%) !important;
  box-shadow: 0 8px 25px rgba(67, 233, 123, 0.4);
  }

  /* ID Card Styles - Version 2 Portrait */
  .id-card-container {
  display: flex;
  justify-content: center;
  margin: 30px 0;
  }

  .id-card {
  width: 5.5cm;
  height: 8.5cm;
  background-color: white;
  position: relative;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
  overflow: hidden;
  border-radius: 10px;
  margin: 0 auto;
  text-align: left; /* Reset from possible parent center alignment */
  }

  .header-container {
  position: relative;
  height: 65px;
  width: 100%;
  }

  .header-red-accent {
  position: absolute;
  top: 0;
  left: 70%;
  width: 50px;
  height: 45px;
  background-color: var(--shuleni-red);
  z-index: 1;
  clip-path: polygon(10% 0, 100% 0, 42% 100%, 10% 100%);
  }

  .header-green-main {
  position: absolute;
  top: 0;
  left: 0;
  width: 85%;
  height: 50px;
  background-color: var(--maseno-green);
  clip-path: polygon(0 0, 100% 0, 82% 100%, 0 100%);
  z-index: 2;
  padding: 8px 12px;
  box-sizing: border-box;
  color: white;
  display: flex;
  flex-direction: column;
  justify-content: center;
  }

  .header-green-main h1 {
  margin: 0;
  font-size: 11px;
  text-transform: uppercase;
  font-weight: 800;
  line-height: 1.1;
  color: white !important;
  }

  .header-green-main p {
  margin: 0;
  font-size: 6px;
  font-style: italic;
  color: rgba(255, 255, 255, 0.9) !important;
  }

  .logo-crest {
  position: absolute;
  top: 8px;
  right: 12px;
  width: 45px;
  height: 45px;
  background: white;
  border-radius: 50%;
  border: 2px solid #e0e0e0;
  box-shadow: inset 0 0 0 1.5px var(--shuleni-red);
  z-index: 10;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  }

  .background-slant {
  position: absolute;
  top: 100px;
  bottom: 0;
  left: 0;
  right: 0;
  background-color: #f4f4f4;
  clip-path: polygon(100% 0, 100% 100%, 0% 100%);
  z-index: 0;
  pointer-events: none;
  }

  .id-card-content {
  position: relative;
  z-index: 5;
  text-align: center;
  margin-top: 5px;
  height: 180px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  }

  .photo-frame {
  width: 2.5cm;
  height: 3.2cm;
  border-radius: 4px;
  overflow: hidden;
  border: 1px solid #ddd;
  background: #eee;
  display: flex;
  align-items: center;
  justify-content: center;
  }

  .photo-placeholder {
  font-size: 8px;
  color: #888;
  }

  .student-name {
  color: var(--maseno-green);
  margin: 4px 0 0 0;
  font-size: 12px;
  font-weight: bold;
  }

  .grade-bar {
  border-bottom: 1px solid var(--shuleni-red);
  margin-bottom: 2px;
  }

  .grade-text {
  color: var(--maseno-green);
  margin: 0;
  font-size: 9px;
  font-weight: bold;
  font-style: italic;
  }

  .adm-text {
  margin: 0;
  font-size: 7px;
  color: #333;
  font-weight: bold;
  }

  .qr-container {
  margin-top: 5px;
  display: flex;
  flex-direction: column;
  align-items: center;
  }

  .qr-box {
  width: 35px;
  height: 35px;
  border: 1px solid #000;
  padding: 2px;
  background: white;
  }

  .qr-box img {
  width: 100%;
  height: 100%;
  }

  .scan-me {
  background: black;
  color: white;
  padding: 1px 4px;
  font-size: 5px;
  font-weight: bold;
  margin-top: -3px;
  }

  /* Footer */
  .footer {
  position: absolute;
  bottom: 0;
  width: 100%;
  }

  .footer-notice {
  text-align: center;
  font-size: 4px;
  color: var(--maseno-green);
  font-weight: bold;
  padding-bottom: 2px;
  text-transform: uppercase;
  }

  .footer-branding {
  height: 45px;
  display: flex;
  position: relative;
  }

  .footer-red-part {
  position: absolute;
  left: 0;
  bottom: 0;
  width: 28%;
  height: 100%;
  background-color: var(--shuleni-red);
  clip-path: url(#red-clip-final);
  z-index: 2;
  padding-left: 4px;
  display: flex;
  align-items: center;
  justify-content: flex-start;
  }

  .footer-green-part {
  position: absolute;
  right: 0;
  bottom: 0;
  width: 78%;
  height: 100%;
  background-color: var(--maseno-green);
  clip-path: url(#green-clip-final);
  z-index: 1;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: flex-end;
  padding-right: 12px;
  color: white;
  }

  .shuleni-text {
  font-size: 20px;
  font-family: 'Brush Script MT', cursive;
  line-height: 0.7;
  }

  .advantage-text {
  font-size: 11px;
  font-weight: bold;
  }

  .smart-card-text {
  font-size: 5px;
  letter-spacing: 2px;
  text-transform: uppercase;
  }

  /* Responsive */
  @media (max-width: 1024px) {
  .sidebar {
  width: 70px;
  }

  .brand h1,
  .nav-links a span:not(.nav-icon),
  .logout-btn span:not(.logout-icon) {
  display: none;
  }

  .brand {
  justify-content: center;
  padding: 20px 10px;
  }

  .main-content {
  margin-left: 70px;
  }

  .nav-links a {
  justify-content: center;
  padding: 14px;
  }
  }

  @media (max-width: 768px) {
  body {
  flex-direction: column;
  }

  .sidebar {
  width: 100%;
  height: auto;
  position: relative;
  flex-direction: row;
  padding: 15px;
  }

  .brand {
  padding: 0 15px;
  margin-bottom: 0;
  border-bottom: none;
  border-right: 1px solid rgba(255, 255, 255, 0.15);
  }

  .nav-links {
  flex-direction: row;
  overflow-x: auto;
  padding: 0 10px;
  }

  .nav-links li {
  margin-bottom: 0;
  margin-right: 5px;
  }

  .logout-section {
  margin-top: 0;
  padding: 0 10px;
  border-top: none;
  border-left: 1px solid rgba(255, 255, 255, 0.15);
  }

  .main-content {
  margin-left: 0;
  padding: 25px 20px;
  }

  .top-row {
  flex-direction: column;
  align-items: flex-start;
  gap: 15px;
  }

  .admin-section {
  width: 100%;
  justify-content: space-between;
  }

  .id-card {
  width: 280px;
  height: 181px;
  }
  }

  /* Print Styles */
  @media print {

  .sidebar,
  .controls,
  .btn,
  .top-row {
  display: none !important;
  }

  .main-content {
  padding: 0;
  margin-left: 0;
  }

  body.batch-mode .id-card-container {
  display: none !important;
  }

  #batchIDCards {
  display: grid !important;
  grid-template-columns: repeat(2, 1fr);
  gap: 20px;
  margin: 0;
  }

  .id-card {
  margin: 0 auto;
  page-break-inside: avoid;
  border: 1px solid #ddd;
  }
  }
  </style>
</head>

<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="brand">
      <img src="/favicon.ico" alt="Shuleni Advantage Logo" class="brand-icon" style="filter:none;">
      <h1>Shuleni Advantage</h1>
    </div>

    <ul class="nav-links">
      <li><a href="admindashboard.html">
          <svg class="nav-icon" viewBox="0 0 24 24">
            <path d="M10,20V14H14V20H19V12H22L12,3L2,12H5V20H10Z" />
          </svg>
          <span>Dashboard</span>
        </a></li>
      <li><a href="students.html">
          <svg class="nav-icon" viewBox="0 0 24 24">
            <path
              d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z" />
          </svg>
          <span>Students</span>
        </a></li>
      <li><a href="parents.html">
          <svg class="nav-icon" viewBox="0 0 24 24">
            <path
              d="M16 17V19H2V17S2 13 9 13 16 17 16 17M12.5 7.5A3.5 3.5 0 1 0 9 11A3.5 3.5 0 0 0 12.5 7.5M15.94 13A5.32 5.32 0 0 1 18 17V19H22V17S22 13.37 15.94 13M15 4A3.39 3.39 0 0 0 13.07 4.59A5 5 0 0 1 13.07 10.41A3.39 3.39 0 0 0 15 11A3.5 3.5 0 0 0 15 4Z" />
          </svg>
          <span>Parents</span>
        </a></li>
      <li><a href="staff.html">
          <svg class="nav-icon" viewBox="0 0 24 24">
            <path
              d="M21.1,12.5L22.5,13.91L15.97,20.5L12.5,17L13.9,15.59L15.97,17.67L21.1,12.5M10,17L13,20H3V18C3,15.79 6.58,14 11,14L12.89,14.11L10,17M11,4A4,4 0 0,1 15,8A4,4 0 0,1 11,12A4,4 0 0,1 7,8A4,4 0 0,1 11,4Z" />
          </svg>
          <span>Staff</span>
        </a></li>
      <li><a href="visitors.html">
          <svg class="nav-icon" viewBox="0 0 24 24">
            <path
              d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z" />
          </svg>
          <span>Visitors</span>
        </a></li>
      <li><a href="student-id-generator.html" class="active">
          <svg class="nav-icon" viewBox="0 0 24 24">
            <path
              d="M14,21H10V19H14M17.71,5.29L19.79,7.37L18.37,8.79L16.29,6.71M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,8A4,4 0 0,1 16,12A4,4 0 0,1 12,16A4,4 0 0,1 8,12A4,4 0 0,1 12,8M12,10A2,2 0 0,0 10,12A2,2 0 0,0 12,14A2,2 0 0,0 14,12A2,2 0 0,0 12,10Z" />
          </svg>
          <span>ID Generator</span>
        </a></li>
      <li><a href="adminsettings.html">
          <svg class="nav-icon" viewBox="0 0 24 24">
            <path
              d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.22,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.22,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.68 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z" />
          </svg>
          <span>Settings</span>
        </a></li>
    </ul>

    <div class="logout-section">
      <button class="logout-btn" id="sidebarLogout">
        <svg class="logout-icon" viewBox="0 0 24 24">
          <path
            d="M16,17V14H9V10H16V7L21,12L16,17M14,2A2,2 0 0,1 16,4V6H14V4H5V20H14V18H16V20A2,2 0 0,1 14,22H5A2,2 0 0,1 3,20V4A2,2 0 0,1 5,2H14Z" />
        </svg>
        <span>Log Out</span>
      </button>
    </div>
  </div>

  <!-- Main Content -->
  <main class="main-content">
    <div class="top-row">
      <h1>Student ID Card Generator</h1>
      <div class="admin-section">
        <div id="adminInfo" class="muted">Welcome back, Admin</div>
        <button class="logout-btn-top" id="topLogout">
          <svg class="logout-icon-top" viewBox="0 0 24 24">
            <path
              d="M16,17V14H9V10H16V7L21,12L16,17M14,2A2,2 0 0,1 16,4V6H14V4H5V20H14V18H16V20A2,2 0 0,1 14,22H5A2,2 0 0,1 3,20V4A2,2 0 0,1 5,2H14Z" />
          </svg>
          Log Out
        </button>
      </div>
    </div>

    <div class="page-header">
      <p>Generate and print student ID cards</p>
    </div>

    <!-- Controls -->
    <div class="controls">
      <div class="form-group">
        <label for="studentSelect">Select Student</label>
        <select id="studentSelect">
          <option value="">-- Select a student --</option>
        </select>
      </div>
      <button class="btn btn-primary" onclick="generateIDCard()">Generate ID Card</button>
      <button class="btn btn-secondary" onclick="printIDCard()">Print ID Card</button>
      <button class="btn btn-secondary" onclick="downloadIDCard()">Download ID Card</button>
      <button class="btn btn-secondary" onclick="generateBatchIDCards()">Generate Batch ID Cards</button>
    </div>

    <!-- ID Card Display -->
    <div class="id-card-container" id="idCardContainer" style="display: none;">
      <div class="id-card" id="idCard">
        <!-- Template will be filled via JS -->
      </div>
    </div>

    <svg width="0" height="0" style="position: absolute;">
      <defs>
        <clipPath id="red-clip-final" clipPathUnits="objectBoundingBox">
          <path d="M0,0 L1,0 L0.25,0.85 Q0.15,0.95 0,1 L0,0 Z" />
        </clipPath>
        <clipPath id="green-clip-final" clipPathUnits="objectBoundingBox">
          <path d="M0.25,0.15 Q0.3,0 0.45,0 L1,0 L1,1 L0,1 L0.25,0.15 Z" />
        </clipPath>
      </defs>
    </svg>

    <!-- Batch ID Cards Container -->
    <div id="batchIDCards"
      style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; margin-top: 30px;">
    </div>
  </main>

  <script src="../runtime-config.js"></script>
  <script src="../shared/api-client.js"></script>
  <script src="app-api.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script>
    let allStudents = [];
    let currentStudent = null;
    let currentQRCodeDataUrl = null;
    let isBatchMode = false;
    let qrCodeLibraryLoaded = false;

    // Default school settings (used as fallback)
    let schoolSettings = {
      school_name: "ST. MARY'S ACADEMY",
      school_motto: "Excellence in Education",
      school_logo_url: "../favicon.ico",
      contact_phone_1: "0738 934 812",
      contact_phone_2: "0713 715 956"
    };

    // Load school settings from database
    async function loadSchoolSettings() {
      try {
        if (typeof settingsAPI !== 'undefined' && settingsAPI.getSchoolSettings) {
          const data = await settingsAPI.getSchoolSettings();
          if (data && data.school_name) {
            schoolSettings = data;
          }
        }
      } catch (error) {
        console.warn('Could not load dynamic school settings, using defaults:', error);
      }
    }

    // Function to generate the HTML structure for a card
    function getCardHTML(student, qrDataUrl) {
      return `
        <div class="header-container">
          <div class="header-red-accent"></div>
          <div class="header-green-main">
            <h1>${schoolSettings.school_name}</h1>
            <p>${schoolSettings.school_motto}</p>
          </div>
          <div class="logo-crest">
            <img src="${schoolSettings.school_logo_url}" alt="Crest" style="width: 80%; object-fit: contain;">
          </div>
        </div>
        
        <div class="background-slant"></div>

        <div class="id-card-content">
          <div class="photo-frame">
            <div class="photo-placeholder">PHOTO</div>
          </div>

          <h2 class="student-name">${student.name || 'N/A'}</h2>
          
          <div class="grade-bar">
            <p class="grade-text">${student.class || 'N/A'} ${student.stream || ''}</p>
          </div>
          <p class="adm-text">ADM NO: ${student.adm || 'N/A'}</p>

          <div class="qr-container">
            <div class="qr-box">
              <img src="${qrDataUrl}" alt="QR Code">
            </div>
            <div class="scan-me">SCAN ME</div>
          </div>
        </div>

        <div class="footer">
          <div class="footer-notice">${schoolSettings.school_name}. - ${schoolSettings.contact_phone_1} / ${schoolSettings.contact_phone_2}</div>
          <div class="footer-branding">
            <div class="footer-red-part">
              <div style="color: white; font-size: 8px; font-weight: bold; text-align: center;">LOGO</div>
            </div>
            <div class="footer-green-part">
              <div class="shuleni-text">Shuleni</div>
              <div class="advantage-text">Advantage<sup>+</sup></div>
              <div class="smart-card-text">Smart Card</div>
            </div>
          </div>
        </div>
      `;
    }

    // Load students and settings on page load
    window.addEventListener('DOMContentLoaded', async function () {
      ensureAuthRedirect();

      try {
        await loadQRCodeLibrary();
      } catch (error) {
        console.error('Error loading QR Code library:', error);
      }

      try {
        await loadSchoolSettings();
      } catch (e) {
        console.error('Failed to load school settings:', e);
      }

      try {
        allStudents = await studentsAPI.getAll();
        populateStudentSelect();
      } catch (error) {
        console.error('Error loading students:', error);
        alert('Failed to load students.');
      }
    });

    function populateStudentSelect() {
      const select = document.getElementById('studentSelect');
      select.innerHTML = '<option value="">-- Select a student --</option>';

      allStudents.forEach(student => {
        const option = document.createElement('option');
        option.value = student.id;
        option.textContent = `${student.adm} - ${student.name} (${student.class || 'N/A'})`;
        option.dataset.student = JSON.stringify(student);
        select.appendChild(option);
      });
    }

    // Generate ID Card
    async function generateIDCard() {
      const select = document.getElementById('studentSelect');
      const selectedOption = select.options[select.selectedIndex];

      if (!selectedOption.value) {
        alert('Please select a student');
        return;
      }

      currentStudent = JSON.parse(selectedOption.dataset.student);
      isBatchMode = false;
      document.body.classList.remove('batch-mode');
      document.getElementById('batchIDCards').style.display = 'none';

      // Generate QR code with only admission number for better scanability
      const qrDataString = currentStudent.adm;

      try {
        const tempDiv = document.createElement('div');
        tempDiv.style.cssText = 'position: absolute; left: -9999px; width: 100px; height: 100px;';
        document.body.appendChild(tempDiv);

        const qr = new QRCode(tempDiv, {
          text: qrDataString,
          width: 100,
          height: 100,
          colorDark: '#000000',
          colorLight: '#FFFFFF',
          correctLevel: QRCode.CorrectLevel.H
        });

        await new Promise(resolve => setTimeout(resolve, 300));

        const qrImg = tempDiv.querySelector('img') || tempDiv.querySelector('canvas');
        if (qrImg) {
          if (qrImg.tagName === 'CANVAS') {
            currentQRCodeDataUrl = qrImg.toDataURL('image/png');
          } else {
            currentQRCodeDataUrl = qrImg.src;
          }
        }

        document.body.removeChild(tempDiv);

        document.getElementById('idCard').innerHTML = getCardHTML(currentStudent, currentQRCodeDataUrl);
        document.getElementById('idCardContainer').style.display = 'flex';

      } catch (error) {
        console.error('Error generating ID card:', error);
        alert('Error generating ID card. Please try again.');
      }
    }

    // Print ID Card
    function printIDCard() {
      if (!currentStudent && !isBatchMode) {
        alert('Please generate an ID card first');
        return;
      }
      window.print();
    }

    // Download ID Card as Image
    async function downloadIDCard() {
      if (isBatchMode) {
        alert('Batch download is not supported yet. Please use Print to save as PDF.');
        return;
      }
      if (!currentStudent || !currentQRCodeDataUrl) {
        alert('Please generate an ID card first');
        return;
      }

      try {
        const idCardElement = document.getElementById('idCard');
        if (!idCardElement) {
          alert('ID card element not found');
          return;
        }

        // Use html2canvas to capture the actual displayed card
        const canvas = await html2canvas(idCardElement, {
          backgroundColor: null,
          scale: 3,
          useCORS: true,
          logging: false,
          width: idCardElement.offsetWidth,
          height: idCardElement.offsetHeight
        });

        canvas.toBlob(blob => {
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.download = `${currentStudent.adm}-id-card.png`;
          link.click();
          URL.revokeObjectURL(url);
        });

      } catch (error) {
        console.error('Error downloading ID card:', error);
        alert('Error downloading ID card. Please try again.');
      }
    }

    // Generate Batch ID Cards
    async function generateBatchIDCards() {
      if (allStudents.length === 0) {
        alert('No students available');
        return;
      }

      if (!confirm(`Generate ID cards for all ${allStudents.length} students?`)) {
        return;
      }

      isBatchMode = true;
      document.body.classList.add('batch-mode');

      const container = document.getElementById('batchIDCards');
      container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 20px;">Generating ID cards...</div>';
      container.style.display = 'grid';
      document.getElementById('idCardContainer').style.display = 'none';

      const buttons = document.querySelectorAll('.controls button');
      buttons.forEach(b => b.disabled = true);

      for (let i = 0; i < allStudents.length; i++) {
        const student = allStudents[i];

        try {
          // Generate QR code with only admission number for better scanability
          const qrDataString = student.adm;

          const tempDiv = document.createElement('div');
          tempDiv.style.cssText = 'position: absolute; left: -9999px; width: 100px; height: 100px;';
          document.body.appendChild(tempDiv);

          const qr = new QRCode(tempDiv, {
            text: qrDataString,
            width: 100,
            height: 100,
            colorDark: '#000000',
            colorLight: '#FFFFFF',
            correctLevel: QRCode.CorrectLevel.H
          });

          await new Promise(resolve => setTimeout(resolve, 200));

          const qrImg = tempDiv.querySelector('img') || tempDiv.querySelector('canvas');
          let qrDataUrl = '';
          if (qrImg) {
            if (qrImg.tagName === 'CANVAS') {
              qrDataUrl = qrImg.toDataURL('image/png');
            } else {
              qrDataUrl = qrImg.src;
            }
          }

          document.body.removeChild(tempDiv);

          const cardDiv = document.createElement('div');
          cardDiv.className = 'id-card';
          cardDiv.innerHTML = getCardHTML(student, qrDataUrl);

          if (i === 0) container.innerHTML = '';
          container.appendChild(cardDiv);

        } catch (error) {
          console.error(`Error generating ID for ${student.name}:`, error);
        }
      }

      buttons.forEach(b => b.disabled = false);

      const summary = document.createElement('div');
      summary.style.gridColumn = '1/-1';
      summary.style.textAlign = 'center';
      summary.style.padding = '20px';
      summary.className = 'no-print';

      const downloadAllBtn = document.createElement('button');
      downloadAllBtn.className = 'btn btn-primary';
      downloadAllBtn.style.marginTop = '10px';
      downloadAllBtn.innerHTML = '<i class="fas fa-download"></i> Download All ID Cards';
      downloadAllBtn.onclick = downloadAllIDCards;

      summary.innerHTML = `<strong>Generated ${allStudents.length} ID cards.</strong><br>Click 'Print ID Card' to print all cards or download them below.`;
      summary.appendChild(downloadAllBtn);
      container.insertBefore(summary, container.firstChild);
    }

    // Download All ID Cards as ZIP
    async function downloadAllIDCards() {
      const container = document.getElementById('batchIDCards');
      const cards = container.querySelectorAll('.id-card');

      if (cards.length === 0) {
        alert('No ID cards generated. Please generate batch ID cards first.');
        return;
      }

      try {
        // Use JSZip library if available, otherwise download individually
        if (typeof JSZip === 'undefined') {
          // Fallback: download cards one by one
          alert('Downloading cards individually...');
          for (let i = 0; i < cards.length; i++) {
            const card = cards[i];
            const canvas = document.createElement('canvas');
            canvas.width = 321;
            canvas.height = 208;
            const ctx = canvas.getContext('2d');

            // Draw card to canvas
            const cardHTML = card.innerHTML;
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = cardHTML;
            tempDiv.style.position = 'absolute';
            tempDiv.style.left = '-9999px';
            document.body.appendChild(tempDiv);

            // Convert to image and download
            await new Promise(resolve => setTimeout(resolve, 100));

            html2canvas(card).then(canvas => {
              canvas.toBlob(blob => {
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                const studentName = card.querySelector('.id-card-name')?.textContent || `student-${i + 1}`;
                link.download = `${studentName.replace(/\s+/g, '-')}-id-card.png`;
                link.click();
                URL.revokeObjectURL(url);
              });
            });

            await new Promise(resolve => setTimeout(resolve, 200));
          }
          alert('All ID cards downloaded!');
        } else {
          // Use JSZip for batch download
          const zip = new JSZip();
          let count = 0;

          for (const card of cards) {
            try {
              const canvas = await html2canvas(card);
              canvas.toBlob(blob => {
                const studentName = card.querySelector('.id-card-name')?.textContent || `student-${count + 1}`;
                zip.file(`${studentName.replace(/\s+/g, '-')}-id-card.png`, blob);
                count++;

                if (count === cards.length) {
                  zip.generateAsync({ type: 'blob' }).then(content => {
                    const url = URL.createObjectURL(content);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = 'all-id-cards.zip';
                    link.click();
                    URL.revokeObjectURL(url);
                    alert('All ID cards downloaded as ZIP file!');
                  });
                }
              });
            } catch (error) {
              console.error('Error processing card:', error);
            }
          }
        }
      } catch (error) {
        console.error('Error downloading ID cards:', error);
        alert('Error downloading ID cards. Please try again.');
      }
    }

    // Logout
    function doLogout() {
      if (confirm('Are you sure you want to log out?')) {
        localStorage.removeItem('sv_admin_token');
        localStorage.removeItem('sv_auth_token');
        localStorage.removeItem('sv_admin_email');
        localStorage.removeItem('sv_user_data');
        window.location.href = '/index.html';
      }
    }

    document.getElementById('sidebarLogout').addEventListener('click', doLogout);
    document.getElementById('topLogout').addEventListener('click', doLogout);

    const adminEmail = localStorage.getItem('sv_admin_email') || 'admin';
    const adminInfoEl = document.getElementById('adminInfo');
    if (adminInfoEl) {
      adminInfoEl.textContent = `Welcome back, ${adminEmail.split('@')[0]}`;
    }
  </script>
</body>

</html>