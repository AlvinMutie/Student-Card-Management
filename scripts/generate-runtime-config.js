const fs = require('fs');
const path = require('path');

const OUTPUT_PATH = path.join(__dirname, '..', 'web', 'runtime-config.js');
const DEFAULT_LOCAL_API = 'http://localhost:3000/api';

const apiBaseFromEnv =
  process.env.API_BASE_URL ||
  process.env.RENDER_API_BASE_URL ||
  process.env.VITE_API_BASE_URL ||
  process.env.REACT_APP_API_BASE_URL;

const normalize = (value) => {
  if (!value) return null;
  let sanitized = value.trim();
  if (sanitized.endsWith('/')) {
    sanitized = sanitized.slice(0, sanitized.length - 1);
  }
  return sanitized;
};

const resolvedApiBase =
  normalize(apiBaseFromEnv) ||
  'https://student-card-management-api.onrender.com/api';

const fileContents = `// This file is auto-generated by scripts/generate-runtime-config.js
// Do not edit directly; set API_BASE_URL when building/deploying instead.
(function (win) {
  win.StudentCardConfig = win.StudentCardConfig || {};
  win.StudentCardConfig.apiBaseUrl = '${resolvedApiBase}';
})(window);
`;

console.log('--- Generating Runtime Config ---');
console.log('Environment Variables Check:');
console.log('API_BASE_URL:', process.env.API_BASE_URL ? 'Set' : 'Not Set');
console.log('RENDER_API_BASE_URL:', process.env.RENDER_API_BASE_URL ? 'Set' : 'Not Set');
console.log('VITE_API_BASE_URL:', process.env.VITE_API_BASE_URL ? 'Set' : 'Not Set');
console.log('REACT_APP_API_BASE_URL:', process.env.REACT_APP_API_BASE_URL ? 'Set' : 'Not Set');
console.log('DEPLOY_PRIME_URL:', process.env.DEPLOY_PRIME_URL);
console.log('Resolved API Base:', resolvedApiBase);

fs.writeFileSync(OUTPUT_PATH, fileContents, 'utf8');
console.log(`runtime-config.js generated successfully at ${OUTPUT_PATH}`);
console.log('---------------------------------');

